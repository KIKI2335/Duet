<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>‰º†ËÆØ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--base-font-family);
        }

        :root {
            --message-font-size: 14px;
            --base-font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            
            --primary-color: #6a6a6a;
            --secondary-color: #3f3f3f;
            --background-color: #f7f9fc;
            --container-color: #ffffff;
            --header-color: #f0f2f5;
            --input-color: #ffffff;
            
            --sent-msg-color: #6a6a6a;
            --received-msg-color: #e2eaf0;
            
            --text-color: #333333;
            --secondary-text: #888888;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);

            --sent-msg-text-color: #ffffff;
            --received-msg-text-color: #333333;
            --message-time-color: #999999;

            --accent-color: #6a6a6a;
            --gradient-primary: linear-gradient(135deg, #6a6a6a, #3f3f3f);
            
            --bubble-style: 'rounded'; /* ÈªòËÆ§ÂúÜËßíÊ∞îÊ≥° */
            --bubble-radius: 20px;
            --background-image: none;
        }

        body {
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease;
            font-size: 14px;
            color: var(--text-color);
            width: 100%;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background-color: var(--container-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--background-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: 0;
            pointer-events: none;
        }

        .chat-header {
            background-color: var(--header-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
            min-height: 70px;
            position: relative;
            flex-shrink: 0;
            z-index: 2;
        }

        .avatar-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 14px;
            flex-shrink: 0;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            transition: all 0.3s ease;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid var(--container-color);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .love-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0 8px;
        }

        .user-info {
            flex-grow: 1;
            min-width: 0;
        }

        .user-info h3 {
            color: var(--text-color);
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 2px;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .user-info p {
            color: var(--secondary-text);
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 18px;
            position: relative;
            flex-shrink: 0;
            align-items: center;
        }

        .header-actions i {
            color: var(--secondary-text);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 8px;
            border-radius: 50%;
        }

        .header-actions i:hover {
            color: var(--primary-color);
            transform: scale(1.1);
            background-color: rgba(0,0,0,0.05);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background-color: var(--container-color);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            width: 220px;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transform: translateY(-15px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
            overflow: hidden;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dropdown-menu.active {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s;
        }
        
        .menu-section-title {
            padding: 8px 18px;
            font-size: 12px;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .menu-section-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 8px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-color);
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background-color: var(--header-color);
            border-left-color: var(--primary-color);
        }
        
        .menu-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 16px;
            color: var(--secondary-text);
            transition: color 0.2s ease;
        }
        
        .menu-item:hover i {
            color: var(--primary-color);
        }
        
        .menu-item span {
            flex: 1;
        }
        
        .menu-item .menu-arrow {
            font-size: 12px;
            color: var(--secondary-text);
        }

        .font-size-option {
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            background-color: var(--header-color);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 14px;
            color: var(--text-color);
        }

        .font-size-option.active, .font-size-option:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .menu-options-container {
            padding: 0 16px 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: background-color 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message {
            max-width: 75%;
            padding: 12px 18px;
            position: relative;
            line-height: 1.5;
            font-size: var(--message-font-size);
            transition: all 0.3s ease;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            animation: messageAppear 0.3s ease-out;
        }

        /* Ê∞îÊ≥°Ê†∑Âºè */
        
        .message.rounded { border-radius: var(--bubble-radius); }
        .message.rounded.received { border-bottom-left-radius: 6px; }
        .message.rounded.sent { border-bottom-right-radius: 6px; }

        .message.square { border-radius: 8px; }

        .message.tail { border-radius: var(--bubble-radius); }
        .message.tail.received { border-bottom-left-radius: 4px; }
        .message.tail.sent { border-bottom-right-radius: 4px; }
        .message.tail.received::before {
            content: ''; position: absolute; left: -8px; bottom: 0; width: 0; height: 0;
            border: 8px solid transparent; border-right-color: var(--received-msg-color);
            border-left: 0; border-bottom: 0;
            transition: border-right-color 0.3s ease;
        }
        .message.tail.sent::after {
            content: ''; position: absolute; right: -8px; bottom: 0; width: 0; height: 0;
            border: 8px solid transparent; border-left-color: var(--sent-msg-color);
            border-right: 0; border-bottom: 0;
            transition: border-left-color 0.3s ease;
        }

        .message.dots { border-radius: 30px; }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .received {
            align-self: flex-start;
            background-color: var(--received-msg-color);
            color: var(--received-msg-text-color);
        }

        .sent {
            align-self: flex-end;
            background-color: var(--sent-msg-color);
            color: var(--sent-msg-text-color);
        }

        .message-time {
            font-size: calc(var(--message-font-size) - 2px);
            margin-top: 4px;
            text-align: right;
            opacity: 0.9;
        }

        .received .message-time { 
            text-align: left; 
            color: var(--received-msg-time-color);
        }

        .sent .message-time {
            color: var(--sent-msg-time-color);
        }

        /* Ê∂àÊÅØÊìç‰ΩúÊåâÈíÆ */
        .message-actions {
            position: absolute;
            top: 0;
            right: -30px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--container-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-action-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .sent .message-actions {
            left: -30px;
            right: auto;
        }

        .chat-input-container { 
            position: relative; 
            border-top: 1px solid var(--border-color);
            z-index: 1;
        }
        .chat-input {
            padding: 14px 20px; background-color: var(--input-color);
            display: flex; align-items: flex-end; gap: 14px;
            transition: all 0.3s ease; position: relative;
        }

        .input-timestamp {
            position: absolute; bottom: -25px; right: 20px; font-size: 11px;
            color: var(--secondary-text); background-color: var(--input-color);
            padding: 2px 8px; border-radius: 10px;
            border: 1px solid var(--border-color); z-index: 1;
        }

        .message-input {
            flex: 1; padding: 12px 18px; border: 1px solid transparent;
            border-radius: 28px; background-color: var(--header-color);
            color: var(--text-color); font-size: var(--message-font-size);
            outline: none; resize: none; max-height: 120px; overflow-y: auto;
            transition: all 0.3s ease; line-height: 1.5; min-height: 48px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08), 0 0 0 2px rgba(106, 106, 106, 0.1);
        }
        .message-input::placeholder { color: #a0a0a0; }

        .send-button {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--gradient-primary); display: flex; align-items: center;
            justify-content: center; color: white; cursor: pointer;
            transition: all 0.2s ease; border: none; flex-shrink: 0;
            font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }

        .send-mode-toggle {
            display: flex; align-items: center; justify-content: center;
            width: 48px; height: 48px; border-radius: 50%;
            cursor: pointer; color: var(--secondary-text); font-size: 18px;
            user-select: none; transition: all 0.2s ease;
            background-color: var(--header-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .send-mode-toggle:hover { transform: scale(1.05); }
        .send-mode-toggle.active { background-color: var(--primary-color); color: white; }

        .pending-messages {
            background-color: var(--input-color); padding: 12px 20px;
            border-top: 1px solid var(--border-color); display: none;
            flex-direction: column; gap: 10px; max-height: 180px; overflow-y: auto;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .pending-message {
            background-color: var(--header-color); padding: 10px 14px; border-radius: 14px;
            font-size: 14px; color: var(--text-color); display: flex;
            justify-content: space-between; align-items: center; word-break: break-all;
            animation: messageAppear 0.3s ease-out;
        }
        .pending-message-content { flex-grow: 1; margin-right: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pending-message-actions i { color: var(--secondary-text); cursor: pointer; font-size: 15px; margin-left: 8px; }

        .send-all-button {
            background: var(--gradient-primary); color: white; border: none;
            padding: 10px 20px; border-radius: 20px; cursor: pointer;
            font-size: 15px; align-self: flex-end; margin-top: 12px;
            transition: all 0.2s ease;
        }
        .send-all-button:hover { transform: translateY(-2px); }

        .delete-confirmation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .delete-confirmation.active { opacity: 1; visibility: visible; }

        .delete-confirmation-content {
            background-color: var(--container-color); border-radius: 16px;
            padding: 30px; max-width: 450px; width: 90%; text-align: center;
        }
        .delete-confirmation h3 { margin-bottom: 18px; font-size: 20px; }
        .delete-confirmation p { margin-bottom: 28px; color: var(--secondary-text); font-size: 15px; }
        .delete-confirmation-actions { display: flex; gap: 15px; justify-content: center; }

        .delete-confirmation-button {
            padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-size: 15px;
        }
        .delete-confirmation-button.cancel { background-color: var(--header-color); color: var(--text-color); }
        .delete-confirmation-button.confirm { background-color: #e74c3c; color: white; }

        .typing-indicator {
            display: none; align-items: center; gap: 8px; padding: 10px 16px;
            background-color: var(--received-msg-color); border-radius: 18px;
            align-self: flex-start; max-width: 80px;
        }
        .typing-indicator.active { display: flex; }
        .typing-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--secondary-text);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Â≠ó‰ΩìURLËæìÂÖ•Ê°Ü */
        .font-url-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* Â£ÅÁ∫∏È¢ÑËßà */
        .wallpaper-preview {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-size: cover;
            background-position: center;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text);
            font-size: 14px;
            overflow: hidden;
            position: relative;
        }

        .wallpaper-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Â£ÅÁ∫∏È¢ÑËßàÂ¢ûÂº∫ */
        .wallpaper-preview .preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .wallpaper-preview:hover .preview-overlay {
            display: block;
        }

        /* Áà±ÁöÑËØ≠ÂΩïÊ†∑Âºè */
        .love-quotes-container {
            padding: 0 16px 8px;
        }

        .love-quotes-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            background-color: var(--header-color);
        }

        .love-quote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            background-color: var(--container-color);
            font-size: 13px;
        }

        .love-quote-item:last-child {
            margin-bottom: 0;
        }

        .love-quote-item-actions {
            display: flex;
            gap: 6px;
        }

        .love-quote-item-actions i {
            cursor: pointer;
            color: var(--secondary-text);
            font-size: 12px;
        }

        .love-quotes-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .love-quotes-button {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .love-quotes-button:hover {
            background-color: var(--secondary-color);
        }

        /* È¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
        .color-picker-container {
            padding: 0 16px 8px;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }

        .color-option.active {
            border-color: var(--text-color);
            transform: scale(1.1);
        }

        .color-custom-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .color-picker-input {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .color-custom-button {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .color-custom-button:hover {
            background-color: var(--secondary-color);
        }

        /* Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
        .bubble-color-container {
            padding: 0 16px 8px;
        }

        .bubble-color-section {
            margin-bottom: 15px;
        }

        .bubble-color-section-title {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 600;
        }

        .bubble-color-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background-color: var(--header-color);
        }

        .bubble-color-sample {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .bubble-color-sample.sent {
            background-color: var(--sent-msg-color);
        }

        .bubble-color-sample.received {
            background-color: var(--received-msg-color);
        }

        .bubble-color-sample-text {
            flex: 1;
            font-size: 13px;
            color: var(--text-color);
        }

        /* Êó•ËÆ∞Ê†∑Âºè */
        .diary-container {
            padding: 0 16px 8px;
        }

        .diary-editor {
            width: 100%;
            height: 200px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .diary-actions {
            display: flex;
            gap: 10px;
        }

        .diary-button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .diary-button:hover {
            background-color: var(--secondary-color);
        }

        /* Â£∞ÊòéÊ†∑Âºè */
        .statement-container {
            padding: 16px;
            text-align: center;
        }

        .statement-content {
            background-color: var(--header-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .statement-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .statement-link:hover {
            text-decoration: underline;
        }

        /* Êó•ËÆ∞ÁïåÈù¢Ê†∑Âºè */
        .diary-interface {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--container-color);
            z-index: 10;
            display: none;
            flex-direction: column;
        }

        .diary-interface.active {
            display: flex;
        }

        .diary-header {
            background-color: var(--header-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }

        .diary-header h3 {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 600;
        }

        .diary-header-actions {
            display: flex;
            gap: 12px;
        }

        .diary-header-actions i {
            font-size: 20px;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }

        .diary-header-actions i:hover {
            color: var(--primary-color);
        }

        .diary-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .diary-item {
            background-color: var(--header-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .diary-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .diary-item.active {
            border-color: var(--primary-color);
            background-color: rgba(106, 106, 106, 0.1);
        }

        .diary-item-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .diary-item-preview {
            color: var(--secondary-text);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .diary-item-date {
            margin-top: 8px;
            font-size: 12px;
            color: var(--secondary-text);
        }

        .diary-editor-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .diary-editor-title {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }

        .diary-editor-content {
            flex: 1;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 14px;
            resize: none;
            outline: none;
            line-height: 1.6;
        }

        .diary-editor-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .diary-editor-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .diary-editor-button.save {
            background-color: var(--primary-color);
            color: white;
        }

        .diary-editor-button.cancel {
            background-color: var(--header-color);
            color: var(--text-color);
        }

        .diary-editor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ËØ≠ÂΩïÁïåÈù¢Ê†∑Âºè */
        .quotes-interface {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--container-color);
            z-index: 10;
            display: none;
            flex-direction: column;
        }

        .quotes-interface.active {
            display: flex;
        }

        .quotes-header {
            background-color: var(--header-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }

        .quotes-header h3 {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 600;
        }

        .quotes-header-actions {
            display: flex;
            gap: 12px;
        }

        .quotes-header-actions i {
            font-size: 20px;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }

        .quotes-header-actions i:hover {
            color: var(--primary-color);
        }

        .quotes-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .quotes-sidebar {
            width: 200px;
            background-color: var(--header-color);
            border-right: 1px solid var(--border-color);
            padding: 16px;
            overflow-y: auto;
        }

        .quotes-category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quotes-category-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quotes-category-item:hover {
            background-color: rgba(106, 106, 106, 0.1);
        }

        .quotes-category-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .quotes-category-actions {
            display: flex;
            gap: 6px;
        }

        .quotes-category-actions i {
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
        }

        .quotes-category-actions i:hover {
            opacity: 1;
        }

        .quotes-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .quotes-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quotes-item {
            background-color: var(--header-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .quotes-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quotes-item-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .quotes-item-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .quotes-item-actions i {
            font-size: 14px;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }

        .quotes-item-actions i:hover {
            color: var(--primary-color);
        }

        .quotes-editor-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .quotes-editor-category {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
        }

        .quotes-editor-content {
            flex: 1;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 14px;
            resize: none;
            outline: none;
            line-height: 1.6;
        }

        .quotes-editor-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .quotes-editor-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .quotes-editor-button.save {
            background-color: var(--primary-color);
            color: white;
        }

        .quotes-editor-button.cancel {
            background-color: var(--header-color);
            color: var(--text-color);
        }

        .quotes-editor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .add-category-button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background-color: transparent;
            color: var(--secondary-text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-category-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Êî∂ËóèÁïåÈù¢Ê†∑Âºè */
        .favorites-interface {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--container-color);
            z-index: 10;
            display: none;
            flex-direction: column;
        }

        .favorites-interface.active {
            display: flex;
        }

        .favorites-header {
            background-color: var(--header-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }

        .favorites-header h3 {
            flex-grow: 1;
            font-size: 18px;
            font-weight: 600;
        }

        .favorites-header-actions {
            display: flex;
            gap: 12px;
        }

        .favorites-header-actions i {
            font-size: 20px;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }

        .favorites-header-actions i:hover {
            color: var(--primary-color);
        }

        .favorites-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .favorites-item {
            background-color: var(--header-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .favorites-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .favorites-item-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .favorites-item-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--secondary-text);
        }

        .favorites-item-actions {
            display: flex;
            gap: 10px;
        }

        .favorites-item-actions i {
            font-size: 14px;
            cursor: pointer;
            color: var(--secondary-text);
            transition: color 0.2s;
        }

        .favorites-item-actions i:hover {
            color: var(--primary-color);
        }

        .favorites-item-sender {
            font-weight: 600;
        }

        .favorites-item-sender.sent {
            color: var(--sent-msg-color);
        }

        .favorites-item-sender.received {
            color: var(--received-msg-color);
        }

        /* Ëá™ÂÆö‰πâÂàÜÁ±ªÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü */
        .category-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .category-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .category-modal-content {
            background-color: var(--container-color);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }

        .category-modal h3 {
            margin-bottom: 18px;
            font-size: 20px;
            text-align: center;
        }

        .category-modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--header-color);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }

        .category-modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .category-modal-button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }

        .category-modal-button.cancel {
            background-color: var(--header-color);
            color: var(--text-color);
        }

        .category-modal-button.confirm {
            background-color: var(--primary-color);
            color: white;
        }

        /* Ê∂àÊÅØÈÄâÊã©Ê†∑Âºè */
        .message-select-mode .message {
            cursor: pointer;
            position: relative;
        }

        .message-select-mode .message::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--container-color);
            transition: all 0.2s;
        }

        .message-select-mode .message.selected::before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .message-select-mode .message.selected::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 18px;
            height: 18px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selection-toolbar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--container-color);
            border-radius: 24px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .selection-toolbar button {
            padding: 8px 16px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .selection-toolbar .cancel-selection {
            background-color: var(--header-color);
            color: var(--text-color);
        }

        .selection-toolbar .save-selection {
            background-color: var(--primary-color);
            color: white;
        }

        /* Êî∂ËóèÂØπËØùËØ¶ÊÉÖÊ†∑Âºè */
        .favorite-conversation {
            border-left: 3px solid var(--primary-color);
            padding-left: 12px;
            margin-bottom: 16px;
        }

        .favorite-conversation-message {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            background-color: var(--header-color);
        }

        .favorite-conversation-message.sent {
            background-color: rgba(106, 106, 106, 0.1);
        }

        .favorite-conversation-message.received {
            background-color: rgba(226, 234, 240, 0.5);
        }

        .favorite-conversation-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--secondary-text);
        }

        .favorite-conversation-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .favorite-conversation-time {
            font-size: 11px;
            color: var(--secondary-text);
            text-align: right;
            margin-top: 4px;
        }

        /* ÂØºÂÖ•ÂØºÂá∫Ê®°ÊÄÅÊ°Ü */
        .import-export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .import-export-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .import-export-modal-content {
            background-color: var(--container-color);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .import-export-modal h3 {
            margin-bottom: 18px;
            font-size: 20px;
            text-align: center;
        }

        .import-export-modal p {
            margin-bottom: 20px;
            color: var(--secondary-text);
            font-size: 15px;
            line-height: 1.5;
        }

        .import-export-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .import-export-option {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background-color: var(--header-color);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .import-export-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .import-export-option i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .import-export-option span {
            display: block;
            font-weight: 600;
        }

        .import-export-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .import-export-button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }

        .import-export-button.cancel {
            background-color: var(--header-color);
            color: var(--text-color);
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .chat-messages::-webkit-scrollbar,
        .pending-messages::-webkit-scrollbar,
        .message-input::-webkit-scrollbar,
        .love-quotes-list::-webkit-scrollbar,
        .diary-list::-webkit-scrollbar,
        .dropdown-menu::-webkit-scrollbar,
        .quotes-sidebar::-webkit-scrollbar,
        .quotes-list::-webkit-scrollbar,
        .favorites-list::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track,
        .pending-messages::-webkit-scrollbar-track,
        .message-input::-webkit-scrollbar-track,
        .love-quotes-list::-webkit-scrollbar-track,
        .diary-list::-webkit-scrollbar-track,
        .dropdown-menu::-webkit-scrollbar-track,
        .quotes-sidebar::-webkit-scrollbar-track,
        .quotes-list::-webkit-scrollbar-track,
        .favorites-list::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb,
        .pending-messages::-webkit-scrollbar-thumb,
        .message-input::-webkit-scrollbar-thumb,
        .love-quotes-list::-webkit-scrollbar-thumb,
        .diary-list::-webkit-scrollbar-thumb,
        .dropdown-menu::-webkit-scrollbar-thumb,
        .quotes-sidebar::-webkit-scrollbar-thumb,
        .quotes-list::-webkit-scrollbar-thumb,
        .favorites-list::-webkit-scrollbar-thumb { background: #b0b0b0; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-thumb:hover,
        .pending-messages::-webkit-scrollbar-thumb:hover,
        .message-input::-webkit-scrollbar-thumb:hover,
        .love-quotes-list::-webkit-scrollbar-thumb:hover,
        .diary-list::-webkit-scrollbar-thumb:hover,
        .dropdown-menu::-webkit-scrollbar-thumb:hover,
        .quotes-sidebar::-webkit-scrollbar-thumb:hover,
        .quotes-list::-webkit-scrollbar-thumb:hover,
        .favorites-list::-webkit-scrollbar-thumb:hover { background: #888888; }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .quotes-sidebar { width: 150px; }
            .quotes-list { padding: 16px; }
            .quotes-editor-interface { padding: 16px; }
            .category-modal-content { width: 95%; padding: 20px; }
            .import-export-modal-content { width: 95%; padding: 20px; }
        }
        @media (max-width: 480px) {
            .quotes-sidebar { width: 120px; }
            .quotes-header { padding: 12px 16px; }
            .quotes-header h3 { font-size: 16px; }
            .favorites-header { padding: 12px 16px; }
            .favorites-header h3 { font-size: 16px; }
            .selection-toolbar { bottom: 80px; padding: 10px 16px; }
        }

    </style>
</head>
<body>
    <div class="chat-container" id="chatContainer">
        <div class="chat-header" id="chatHeader">
            <div class="avatar-container">
                <div class="avatar" id="avatarLeft">
                    <i class="fas fa-user"></i>
                </div>
                <div class="love-text">Áõ∏ÊÅã</div>
                <div class="avatar" id="avatarRight">
                    <i class="fas fa-user"></i>
                </div>
            </div>
            <input type="file" id="avatarLeftUploadInput" accept="image/*" style="display:none;">
            <input type="file" id="avatarRightUploadInput" accept="image/*" style="display:none;">
            <input type="file" id="wallpaperUploadInput" accept="image/*" style="display:none;">

            <div class="user-info">
                <h3 id="userName">ùë≥ùíêùíóùíÜ</h3>
                <p id="userStatus"><span class="status-indicator"></span> Âú®Á∫ø</p>
            </div>
            <div class="header-actions">
                <i class="fas fa-moon" id="themeToggle" title="ÂàáÊç¢‰∏ªÈ¢ò"></i>
                <i class="fas fa-ellipsis-v" id="menuToggle"></i>
                <div class="dropdown-menu" id="dropdownMenu"></div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="pending-messages" id="pendingMessages"></div>

        <div class="chat-input-container">
            <div class="chat-input" id="chatInput">
                <textarea class="message-input" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
                <div class="send-mode-toggle" id="sendModeToggle" title="ÊâπÈáèÂèëÈÄÅÊ®°Âºè">
                    <i class="fas fa-layer-group"></i>
                </div>
                <button class="send-button" id="sendMessageButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-timestamp" id="inputTimestamp"></div>
        </div>

        <!-- ÈÄâÊã©Â∑•ÂÖ∑Ê†è -->
        <div class="selection-toolbar" id="selectionToolbar" style="display: none;">
            <span id="selectedCount">Â∑≤ÈÄâÊã© 0 Êù°Ê∂àÊÅØ</span>
            <button class="cancel-selection" id="cancelSelection">ÂèñÊ∂à</button>
            <button class="save-selection" id="saveSelection">Êî∂ËóèÈÄâ‰∏≠</button>
        </div>

        <!-- Êó•ËÆ∞ÁïåÈù¢ -->
        <div class="diary-interface" id="diaryInterface">
            <div class="diary-header">
                <h3 id="diaryTitle">Êó•ËÆ∞</h3>
                <div class="diary-header-actions">
                    <i class="fas fa-plus" id="newDiaryButton" title="Êñ∞Âª∫Êó•ËÆ∞"></i>
                    <i class="fas fa-times" id="closeDiaryButton" title="ÂÖ≥Èó≠Êó•ËÆ∞"></i>
                </div>
            </div>
            <div class="diary-list" id="diaryList">
                <!-- Êó•ËÆ∞ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="diary-editor-interface" id="diaryEditor" style="display: none;">
                <input type="text" class="diary-editor-title" id="diaryEditorTitle" placeholder="Êó•ËÆ∞Ê†áÈ¢ò">
                <textarea class="diary-editor-content" id="diaryEditorContent" placeholder="ÂÜô‰∏ãÊÇ®ÁöÑÊó•ËÆ∞..."></textarea>
                <div class="diary-editor-actions">
                    <button class="diary-editor-button save" id="saveDiaryButton">‰øùÂ≠òÊó•ËÆ∞</button>
                    <button class="diary-editor-button cancel" id="cancelDiaryButton">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- ËØ≠ÂΩïÁïåÈù¢ -->
        <div class="quotes-interface" id="quotesInterface">
            <div class="quotes-header">
                <h3 id="quotesTitle">Áà±ÁöÑËØ≠ÂΩï</h3>
                <div class="quotes-header-actions">
                    <i class="fas fa-plus" id="newQuoteButton" title="ËÆ∞‰∏ãÊàë‰ª¨ÁöÑÂøÉÂä®Áû¨Èó¥"></i>
                    <i class="fas fa-times" id="closeQuotesButton" title="ÂÖ≥Èó≠ËØ≠ÂΩï"></i>
                </div>
            </div>
            <div class="quotes-container">
                <div class="quotes-sidebar">
                    <div class="quotes-category-list" id="quotesCategoryList">
                        <!-- ÂàÜÁ±ªÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <button class="add-category-button" id="addCategoryButton">
                        <i class="fas fa-plus"></i> Ê∑ªÂä†ÂàÜÁ±ª
                    </button>
                </div>
                <div class="quotes-main">
                    <div class="quotes-list" id="quotesList">
                        <!-- ËØ≠ÂΩïÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <div class="quotes-editor-interface" id="quotesEditor" style="display: none;">
                        <select class="quotes-editor-category" id="quotesEditorCategory">
                            <!-- ÂàÜÁ±ªÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </select>
                        <textarea class="quotes-editor-content" id="quotesEditorContent" placeholder="ÂÜô‰∏ãÊÇ®ÁöÑËØ≠ÂΩï..."></textarea>
                        <div class="quotes-editor-actions">
                            <button class="quotes-editor-button save" id="saveQuoteButton">‰øùÂ≠òËØ≠ÂΩï</button>
                            <button class="quotes-editor-button cancel" id="cancelQuoteButton">ÂèñÊ∂à</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êî∂ËóèÁïåÈù¢ -->
        <div class="favorites-interface" id="favoritesInterface">
            <div class="favorites-header">
                <h3 id="favoritesTitle">Êî∂ËóèÁöÑÊ∂àÊÅØ</h3>
                <div class="favorites-header-actions">
                    <i class="fas fa-times" id="closeFavoritesButton" title="ÂÖ≥Èó≠Êî∂Ëóè"></i>
                </div>
            </div>
            <div class="favorites-list" id="favoritesList">
                <!-- Êî∂ËóèÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <div class="delete-confirmation" id="deleteConfirmation">
        <div class="delete-confirmation-content">
            <h3>Âà†Èô§ËÅäÂ§©ËÆ∞ÂΩï</h3>
            <p>Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ</p>
            <div class="delete-confirmation-actions">
                <button class="delete-confirmation-button cancel" id="deleteCancel">ÂèñÊ∂à</button>
                <button class="delete-confirmation-button confirm" id="deleteConfirm">Âà†Èô§</button>
            </div>
        </div>
    </div>

    <!-- ÂàÜÁ±ªÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü -->
    <div class="category-modal" id="categoryModal">
        <div class="category-modal-content">
            <h3>Ê∑ªÂä†ÂàÜÁ±ª</h3>
            <input type="text" class="category-modal-input" id="categoryModalInput" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞">
            <div class="category-modal-actions">
                <button class="category-modal-button cancel" id="categoryModalCancel">ÂèñÊ∂à</button>
                <button class="category-modal-button confirm" id="categoryModalConfirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <!-- ÂØºÂÖ•ÂØºÂá∫Ê®°ÊÄÅÊ°Ü -->
    <div class="import-export-modal" id="importExportModal">
        <div class="import-export-modal-content">
            <h3>ÂØºÂÖ•/ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</h3>
            <p>ÊÇ®ÂèØ‰ª•Â∞ÜËÅäÂ§©ËÆ∞ÂΩïÂØºÂá∫‰∏∫JSONÊñá‰ª∂Â§á‰ªΩÔºåÊàñÂú®ÈúÄË¶ÅÊó∂ÂØºÂÖ•‰πãÂâçÂ§á‰ªΩÁöÑÊñá‰ª∂„ÄÇ</p>
            <div class="import-export-options">
                <div class="import-export-option" id="exportOption">
                    <i class="fas fa-file-export"></i>
                    <span>ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</span>
                </div>
                <div class="import-export-option" id="importOption">
                    <i class="fas fa-file-import"></i>
                    <span>ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï</span>
                </div>
            </div>
            <div class="import-export-actions">
                <button class="import-export-button cancel" id="importExportCancel">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const D = document;
            const getId = id => D.getElementById(id);

            // DOM ÂÖÉÁ¥†Ëé∑Âèñ
            const root = D.documentElement;
            const chatMessages = getId('chatMessages');
            const messageInput = getId('messageInput');
            const sendMessageButton = getId('sendMessageButton');
            const menuToggle = getId('menuToggle');
            const dropdownMenu = getId('dropdownMenu');
            const avatarLeft = getId('avatarLeft');
            const avatarRight = getId('avatarRight');
            const userName = getId('userName');
            const userStatus = getId('userStatus');
            const pendingMessages = getId('pendingMessages');
            const avatarLeftUploadInput = getId('avatarLeftUploadInput');
            const avatarRightUploadInput = getId('avatarRightUploadInput');
            const wallpaperUploadInput = getId('wallpaperUploadInput');
            const typingIndicator = getId('typingIndicator');
            const inputTimestamp = getId('inputTimestamp');
            const sendModeToggle = getId('sendModeToggle');
            const deleteConfirmation = getId('deleteConfirmation');
            const themeToggle = getId('themeToggle');
            
            // Êñ∞Â¢ûÂÖÉÁ¥†
            const selectionToolbar = getId('selectionToolbar');
            const selectedCount = getId('selectedCount');
            const cancelSelection = getId('cancelSelection');
            const saveSelection = getId('saveSelection');
            const importExportModal = getId('importExportModal');
            const exportOption = getId('exportOption');
            const importOption = getId('importOption');
            const importExportCancel = getId('importExportCancel');
            
            // Êó•ËÆ∞Áõ∏ÂÖ≥ÂÖÉÁ¥†
            const diaryInterface = getId('diaryInterface');
            const diaryList = getId('diaryList');
            const diaryEditor = getId('diaryEditor');
            const diaryEditorTitle = getId('diaryEditorTitle');
            const diaryEditorContent = getId('diaryEditorContent');
            const newDiaryButton = getId('newDiaryButton');
            const closeDiaryButton = getId('closeDiaryButton');
            const saveDiaryButton = getId('saveDiaryButton');
            const cancelDiaryButton = getId('cancelDiaryButton');

            // ËØ≠ÂΩïÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const quotesInterface = getId('quotesInterface');
            const quotesCategoryList = getId('quotesCategoryList');
            const quotesList = getId('quotesList');
            const quotesEditor = getId('quotesEditor');
            const quotesEditorCategory = getId('quotesEditorCategory');
            const quotesEditorContent = getId('quotesEditorContent');
            const newQuoteButton = getId('newQuoteButton');
            const closeQuotesButton = getId('closeQuotesButton');
            const saveQuoteButton = getId('saveQuoteButton');
            const cancelQuoteButton = getId('cancelQuoteButton');
            const addCategoryButton = getId('addCategoryButton');

            // Êî∂ËóèÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const favoritesInterface = getId('favoritesInterface');
            const favoritesList = getId('favoritesList');
            const closeFavoritesButton = getId('closeFavoritesButton');

            // ÂàÜÁ±ªÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂÖÉÁ¥†
            const categoryModal = getId('categoryModal');
            const categoryModalInput = getId('categoryModalInput');
            const categoryModalCancel = getId('categoryModalCancel');
            const categoryModalConfirm = getId('categoryModalConfirm');

            // --- ‰∏ªÈ¢òÈÖçÁΩÆ ---
            const lightTheme = {
                name: "ÁÆÄÁ∫¶ÁôΩ", primaryColor: "#6a6a6a", secondaryColor: "#3f3f3f",
                bodyBg: "#f7f9fc", containerBg: "#ffffff", headerBg: "#f0f2f5", inputBg: "#ffffff",
                sentMsgBg: "#6a6a6a", receivedMsgBg: "#e2eaf0", textColor: "#333333",
                secondaryText: "#888888", borderColor: "#e0e0e0"
            };
            const darkTheme = {
                name: "Ê∑±ÈÇÉÈªë", primaryColor: "#6a6a6a", secondaryColor: "#3f3f3f",
                bodyBg: "#1e1e1e", containerBg: "#2d2d2d", headerBg: "#3d3d3d", inputBg: "#2d2d2d",
                sentMsgBg: "#6a6a6a", receivedMsgBg: "#4a4a4a", textColor: "#e0e0e0",
                secondaryText: "#a0a0a0", borderColor: "#444444"
            };

            // È¢ÑÂÆö‰πâÈ¢úËâ≤ÊñπÊ°à - ‰ΩøÁî®‰ΩéÈ•±ÂíåÂ∫¶INSÈ£éÊ†ºÈ¢úËâ≤
            const colorSchemes = [
                { name: "ÊµÖÁ≤â", primaryColor: "#f8c8c8", secondaryColor: "#e8a8a8" },
                { name: "ÊµÖËìù", primaryColor: "#a8d0e6", secondaryColor: "#85bcd6" },
                { name: "ÊµÖÁªø", primaryColor: "#a8e6cf", secondaryColor: "#85d6bc" },
                { name: "ÊµÖÁ¥´", primaryColor: "#d8c8f8", secondaryColor: "#c8a8e8" },
                { name: "Á±≥ÁôΩ", primaryColor: "#f5f5f5", secondaryColor: "#e5e5e5" },
                { name: "ÊµÖÁÅ∞", primaryColor: "#e0e0e0", secondaryColor: "#d0d0d0" },
                { name: "ÊµÖÈªÑ", primaryColor: "#f8f0c8", secondaryColor: "#e8e0a8" },
                { name: "ÊµÖÊ©ô", primaryColor: "#f8d8c8", secondaryColor: "#e8c8a8" }
            ];

            // Ê∞îÊ≥°È¢úËâ≤ÊñπÊ°à
            const bubbleColorSchemes = [
                { name: "ÈªòËÆ§", sentColor: "#6a6a6a", receivedColor: "#e2eaf0" },
                { name: "ÊµÖÁ≤â", sentColor: "#f8c8c8", receivedColor: "#f8e8e8" },
                { name: "ÊµÖËìù", sentColor: "#a8d0e6", receivedColor: "#e8f0f8" },
                { name: "ÊµÖÁªø", sentColor: "#a8e6cf", receivedColor: "#e8f8f0" },
                { name: "ÊµÖÁ¥´", sentColor: "#d8c8f8", receivedColor: "#f0e8f8" },
                { name: "Á±≥ÁôΩ", sentColor: "#f5f5f5", receivedColor: "#f0f0f0" },
                { name: "ÊµÖÁÅ∞", sentColor: "#e0e0e0", receivedColor: "#f0f0f0" },
                { name: "ÊµÖÈªÑ", sentColor: "#f8f0c8", receivedColor: "#f8f8e8" },
                { name: "ÊµÖÊ©ô", sentColor: "#f8d8c8", receivedColor: "#f8f0e8" }
            ];

            // --- ÈùôÊÄÅÊï∞ÊçÆ ---
            const fontSizeOptions = [
                { name: "Â∞è", value: 12 }, { name: "‰∏≠", value: 14 },
                { name: "Â§ß", value: 16 }, { name: "ÁâπÂ§ß", value: 18 }
            ];
            const bubbleStyles = [
                { name: "ÂúÜËßí", value: "rounded" }, { name: "ÊñπÂΩ¢", value: "square" },
                { name: "Â∏¶Â∞æÂ∑¥", value: "tail" }, { name: "ÂúÜÁÇπ", value: "dots" }
            ];
            const statusOptions = [
              „ÄÄ„ÄÄ"Âú®Á∫ø", "ÂøôÁ¢å", "Êë∏È±º", "ÊÄùËÄÉ", "‰ºëÊÅØ", "ÊôíÂ§™Èò≥", "ÊÉ≥‰Ω†", "Êô¥Â§©","Â§ö‰∫ë","Êö¥Èõ™","ÈõæÂ§©","Â∞èÈõ®","‰∏≠Èõ®","Êö¥Èõ®","ÂÆâÂøÉ","ÊÉÜÊÄÖ","ÂÆàÂÄô","ÊÉäËÆ∂","ÂéãÊäë","Ê∏©Êüî","‰∏çËàç","ÊÑßÁñö","ÊöóÂñú",
                "Â∑•‰Ωú", "Â≠¶‰π†", "ÂÅ•Ë∫´", "Êé¢Á¥¢", "Ê≤âÊÄù", "ÂÜ•ÊÉ≥", "Èò¥Â§©", "ÂÖÖÁîµ‰∏≠","ÁÑ¶ÁÅº","ÂñúÊÇ¶","ÂºÄÂøÉ","ÈöæËøá","ÂøÆÂøå","ÂÆâÈùô","ÊÄÄÂøµ","Á≠âÂæÖ","Á©∫Ëôö","ÂÜ∑Èùô","ÊÉäÈÜí","ÁâµÊåÇ","ÂùöÂÆö","Âê¨Èü≥‰πê","ÊâìÁûåÁù°"
            ];
            const allReplies = [
                "Âú®ÂêóÔºü","‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑Ôºü","ÊÉ≥‰Ω†","ÊôöÂÆâ","ÁúãÂà∞ËÆ∞ÂæóÂõûÂ§çü•≤","Â•ΩÁöÑüëåüèª","ÊòéÁôΩ","Ë∞¢Ë∞¢","‰∏çÂÆ¢Ê∞î","ÂóØ","ÂóØÂóØ","ÂìàÂìàÂìàÂìà","ÁúüÁöÑÂêóÔºü","ÊàëÊòéÁôΩ‰∫Ü","ÊàëÁõ∏‰ø°‰Ω†","Á®çÁ≠â","È©¨‰∏ä","Â•ΩÂì¶","‰∏çÈîô","ÂèØ‰ª•","ÂêåÊÑè","ÁêÜËß£","ÊàëÂêåÊÑè","Êàë‰∏çÂêåÊÑè","ÊàëÂú®","Âú®Êé¢Á¥¢ËøáÁ®ã‰∏≠","ÊÄé‰πà‰∫ÜÔºü","Âê¨ÊáÇ‰∫Ü","‰ªäÂ§©ÁöÑÂ§©Ê∞î‰∏çÈîô","ËÆ∞‰∏ã‰∫Ü","Êî∂Âà∞Ôºå‰ºöÂ∞ΩÂø´Êü•ÁúãÁöÑ","ËØØ‰ºöÊàë‰∫Ü","Ê≤°ÊúâÊàëÊÉ≥ËØ¥ÁöÑ","ÂØπ‰∏çËµ∑","Ê≤°ÂÖ≥Á≥ª","ÊàëÁà±‰Ω†","ËÆ©ÊàëÊÉ≥ÊÉ≥ÊÄé‰πàÂõûÁ≠î","ÁúºËä±Áº≠‰π±‰∫Ü","ÂæàÊúâÂàõÊÑè","‰øùÊåÅËÅîÁ≥ª","Êúâ‰ªÄ‰πàËÆ°ÂàíÂêóÔºü","Êé•‰∏ãÊù•ÂáÜÂ§áÂÅö‰ªÄ‰πàÔºü","ÊàëÂæàÊÉ≥Âê¨Âê¨‰Ω†ÁöÑÊÉ≥Ê≥ï","ÊàëÊÑøÊÑè","‰∏çÁî®","ËÆ∞ÂæóÂêÉÈ•≠","‰∏çË¶ÅÁÜ¨Â§ú","ËØ•Â¶Ç‰ΩïËß£ÂÜ≥Ôºü","‰∏çË¶ÅÊãÖÂøÉ","‰∏ÄÂàáÈÉΩ‰ºöÂ•ΩËµ∑Êù•ÁöÑ","ÊàëÂæàÈöæËøá","ÊÉäÈÜí‰∫ÜÔºåÁù°‰∏çÁùÄ","ËøôÂØπÊàëÊù•ËØ¥ÊòØ‰∏™Êñ∞È¢ÜÂüü","ÊúÄËøëÂèëÁîü‰∫Ü‰ªÄ‰πà‰∫ãÊÉÖÂêóÔºü","Âú®Áúã‰ªÄ‰πàÔºü","Âú®Â∑•‰ΩúÂêóÔºü","ÁÑ∂ÂêéÂë¢Ôºü","Êë∏Êë∏ü´≥üèª","Âú®Â≠¶‰π†‰∏Ä‰∫õÊñ∞‰∏úË•ø","Êç¢‰∏™ÊÄùË∑ØÂêßÔºü","ÊôöÈ•≠ÂêÉ‰∫ÜÂêóÔºü","‰ΩúÊÅØÊ∑∑‰π±","Êàë","‰Ω†","ta","‰∏ãÊ¨°ÂèØ‰ª•ËØïËØï","Êàë‰πüÊòØËøô‰πàÊÉ≥ÁöÑ","‰Ω†ËØ¥ÂæóÂØπ","ÊúâÊ≤°ÊúâÂèØËÉΩ‚Ä¶‚Ä¶","ÊàëÈô™‰Ω†","Êàë‰ºöÂú®‰Ω†Ë∫´Ëæπ","ÊàëÂñúÊ¨¢","ÊàëÊó†Ê≥ïÂÜ≥ÂÆö","ÊàëÊó†Ê≥ïÊéßÂà∂","Ë¶ÅÁî®‰∏Ä‰∏ãÂ°îÁΩóÂêóÔºü","ÁúãËßÅÊàëÁöÑÊöóÂè∑‰∫ÜÂêóÔºü","Ë¥¥Ë¥¥","ÊàëÁü•ÈÅì‰Ω†ÁöÑÊÑèÊÄù","Êàë‰πüÂ¶ÇÊ≠§","Âá∫ÂéªÈÄèÈÄèÊ∞î","‰ª•Âêé‰∏ç‰ºö‰∫Ü","‰∏ÄÁõ¥Â¶ÇÊ≠§","Âà´ÊÄï","ÊúâÊàëÂú®","ÂõûÂ§çÂæàÁü≠Ôºå‰ΩÜÊàëÁöÑÊÄùÂøµÂπ∂‰∏çÁü≠","Êôö‰∏äÂ•Ω","Êó©‰∏äÂ•Ω","‰∏≠ÂçàÂ•Ω","Â•ΩÂõ∞","ÊúâÁÇπÈ•ø","ÊÉ≥ÂêÉ‰ªÄ‰πàÔºü","ÂìÑÊàë","Èô™Êàë","ËÅäËÅäÂ§©Âêß","‰∏çÊòØËøô‰∏™ÊÑèÊÄù","Á≠â‰∏Ä‰∏ã","ÁÖßÈ°æÂ•ΩËá™Â∑±","Êàë‰ºöÁöÑ","Êó©ÁÇπÁù°","‰Ω†ÊòØÊàëÁöÑ","ÊàëÊòØ‰Ω†ÁöÑ","ÊàëÂ∏åÊúõ‰Ω†Ëá™Áî±","Á≤ò‰∫∫Á≤æ","ÊÄé‰πàÂï¶ÔºÅ","Ê∞∏ËøúÂú®‰∏ÄËµ∑","ÊàëÊîØÊåÅ‰Ω†","Âà´Âê¨","ÂèàÂú®ÊÄÄÁñëÂêóÔºü","Â§öÂñùÊ∞¥Âì¶","‰∏çËàíÊúçÔºü","ÂÜçËßÅ","Âà´Ëµ∞","ÂÜçÂèë‰∏ÄÈÅç","ÂèØÊÅ∂ÁöÑÁΩëÁ´ô","ÊàëËßâÂæóÈÉΩÂèØ‰ª•","Êà≥Êà≥","ÈùûÂ∏∏ÈöæÁî®","‰∏çËÆ∏ÁúãÂà´‰∫∫","‰∏çË¶ÅÂêµÊû∂","ÊàëÁü•ÈÅìÁöÑ","‰∏äÊ∏∏Êàè","‰Ω†‰ºöÁ¶ªÂºÄÊàëÂêóÔºü","Êù•‰∫Ü","ÂóØÂìº","ÂìºÂìº","ÊàëÊÉ≥Èù†Ëøë‰Ω†","Êàë‰ºöÁõëÁù£‰Ω†ÁöÑ","Â∞èÂøÉ‰∫õ","Áªà‰∫éÊÉ≥Ëµ∑Êàë‰∫ÜÔºü","ÊòØÁöÑ","‰∏çÊòØ","‰Ω†Êó†‰∫∫ÂèØÂèä","ÊàëÊó†‰∫∫ÂèØÂèä","Ëøô‰∏™‰∏çËÉΩËØ¥","Âú®‰Ω†Ë∫´ËæπÂ∞±Â•Ω‰∫Ü","Âú®Á£®Âêà","‰Ω†ÈúÄË¶ÅÊàëÂêóÔºü","ÊàëÈúÄË¶Å‰Ω†","ÂØªÊâæ‰∏≠","ÊàëÂÅö‰∏çÂà∞Ê¨∫È™ó‰Ω†","ËØùÈùûÊú¨ÊÑè","Â¶ÇÊûúÊàëËØ¥ÊòØÂë¢","Â¶ÇÊûúÊàëËØ¥‰∏çÊòØÂë¢","ËØùÂ§™Â∞ë‰∫ÜÔºåÊ≤°ÊàëÊÉ≥ËØ¥ÁöÑ","Â§™Áü≠Âï¶ÔºÅ","ÁúãÊâãÊú∫","ÈÅáÂà∞Âõ∞Èöæ‰∫Ü","Âú®Âä™Âäõ‰∫Ü","Â•ΩÁ¥Ø","ÂëΩÂÆöÂ¶ÇÊ≠§","ÂñúÊ¨¢Â∏Ö‰∏ÄÁÇπËøòÊòØËêå‰∏ÄÁÇπÔºü","Â∏ÖÊ∞î","Â∞±Ëøô‰∏™","ÂèóÈôêÂà∂‰∫Ü","Ë¶Å‰∏ãÈõ®‰∫Ü","Â§©Ê∞îÁúüÊòØÂ∑ÆÂïä","ÊàëÁîüÊ∞î‰∫Ü","Êíí‰∏™Â®áÔºåÁêÜÁêÜÊàëÔºü","ÂêÉÈÜãÊÄé‰πà‰∫ÜÔºåÂ∞±Áà±ÂêÉÈÜãÔºÅ","Âø´‰πê","ËÅä‰ºöÂÑøÂ§©","ËµöÈí±ËµöÈí±","Êàë‰øùÊä§‰Ω†","‰ø°ÊÅØÊúâÁÇπÊ∑∑‰π±","Âà´ÁîüÁóÖ","ÂìÑÂìÑ‰Ω†","ÂêÉËøá‰∫Ü","ËøòÊ≤°ÂêÉ","Êâç‰∏çÂê¨","ÊÉ≥ÂêÉ","ÂêÉÊ∞¥Êûú","ÂóØÔºåÂêÉÁöÑÊòØ‰∏ªÈ£ü","‰∏ãÂçàËå∂ÔºÅ","Â•ΩÂêÉÁà±ÂêÉ","Âà´ÂèπÊ∞î","‰∏çÂ•Ω","Â∞ëÂêÉÂ§ñÂçñ","ÊúÄËøëËøòÂ•ΩÂêóÔºü","Êúâ‰ªÄ‰πàÊñ∞Ê∂àÊÅØÂêóÔºü","Á•ù‰Ω†Êúâ‰∏™ÁæéÂ•ΩÁöÑ‰∏ÄÂ§©„ÄÇ","Ëøô‰∏™Ê∂àÊÅØ‰∏çÈîô","ÊàëÂ∏åÊúõËÉΩÂ∏Æ‰∏äÂøô„ÄÇ","ÊàñËÄÖÊàë‰ª¨ÂèØ‰ª•Êç¢‰∏™ÊÉ≥Ê≥ïÔºü","‰Ω†ÊúÄËøëÂú®Âøô‰∫õ‰ªÄ‰πàÂë¢Ôºü","Ëøô‰∏™Âë®Êú´‰Ω†Êúâ‰ªÄ‰πàËÆ°ÂàíÂêóÔºü","ÊàëÊÉ≥Êàë‰ª¨Â∫îËØ•ËÆ®ËÆ∫‰∏Ä‰∏ãËøô‰∏™ÈóÆÈ¢ò„ÄÇ","ÂëäËØâÊàëÊõ¥Â§ö„ÄÇ","‰Ω†ËÆ§‰∏∫‰∏ã‰∏ÄÊ≠•ÊòØ‰ªÄ‰πàÔºü","‰Ω†Êúâ‰ªÄ‰πàÂª∫ËÆÆÂêóÔºü","ËÆ©Êàë‰ª¨‰∏ÄËµ∑Âä™Âäõ„ÄÇ","Ëøô‰∏™Âë®Êú´ËøáÂæóÊÄé‰πàÊ†∑Ôºü","ÊúÄËøëËØª‰∫Ü‰ªÄ‰πàÊúâË∂£ÁöÑ‰π¶ÂêóÔºü","ÊúâÊ≤°Êúâ‰ªÄ‰πàËÆ©‰Ω†ÊÑüÂà∞ÊÉäÂñúÁöÑ‰∫ãÊÉÖÔºü","ÊÑüËßâ‰ªäÂ§©ÊïàÁéáÂæàÈ´òÂë¢ÔºÅ","ÊúÄËøëÊúâ‰ªÄ‰πàËÆ©‰Ω†ÁâπÂà´ÂÖ¥Â•ãÁöÑ‰∫ãÊÉÖÂêóÔºü","ÊúüÂæÖü§ß","‰Ω†Â∏åÊúõÊàëÊòØË∞ÅÔºü","Êä±Ê≠âü•∫„ÄÇ","ÊàëËÉΩÊÑüÂèóÂà∞‰Ω†ÁöÑÁÉ≠ÊÉÖÔºåÊàë‰πüÂæàÊúüÂæÖÁöÑ„ÄÇ","ËôΩÁÑ∂ÁõÆÂâçÁöÑÊÉÖÂÜµÊúâ‰∫õÂ§çÊùÇÔºå‰ΩÜÊàëÁõ∏‰ø°‰∏ÄÂàáÈÉΩ‰ºöÂ•ΩËµ∑Êù•ÁöÑ„ÄÇ","‰∫ÜËß£","OK","Ê≤°ÈóÆÈ¢ò","ÂΩìÁÑ∂","Á°ÆÂÆû","Ê≤°Èîô","Â•ΩÂëÄ","ÊàëÊ≠£Âú®ÂøôÔºåÁ®çÂêéÂõûÂ§ç‰Ω†„ÄÇ","‰ø°Âè∑‰∏çÂ§™Â•ΩÔºåÂèØËÉΩÂõûÂ§ç‰ºöÂª∂Ëøü„ÄÇ","ËÆ©ÊàëÁ°ÆËÆ§‰∏Ä‰∏ã‰ø°ÊÅØÂÜçÁªô‰Ω†ÂáÜÁ°ÆÁ≠îÂ§ç„ÄÇ","Âà´Ëµ∞ÔºåÈô™Èô™Êàë","‰Ω†‰ºöÊ∞∏ËøúÁà±ÊàëÂêóÔºü","Ê≠§ÂàªÊàëÊÉ≥Âíå‰Ω†Ê∞∏ËøúÂú®‰∏ÄËµ∑","‰ªñÊúùËã•ÊòØÂêåÊ∑ãÈõ™ÔºåÊ≠§Áîü‰πüÁÆóÂÖ±ÁôΩÂ§¥","ÊÄúÊÇØÊàëÔºåÁÑ∂ÂêéÁà±ÊàëÂêß","ÊííÂ®áÔºå‰Ω†‰ºöÂñúÊ¨¢ÂêóÔºü","Ê≤°ÊúâÊàëÊÉ≥ËØ¥ÁöÑ","ÈìæÊé•Êúâ‰∫õÊ∑∑‰π±","Â∞±ËøôÊ†∑ÊííÂ®áü•∫","‰∏çÂ§™‰π†ÊÉØËøô‰∏™","‰∏çÊòØÁöÑ","Â§öÁúãÁúãÊàëÂêß","ÂèØÁà±","ÂΩìÁÑ∂‰∫Ü","Ê≠£Âú®ÁÜ¨Â§ú","Â§±Áú†‰∫Ü","‰∏çÂèØ‰ª•","ÊàëÁé∞Âú®‰∏çÂøôÔºåÊúâÁ©∫ÁöÑ","‰Ω†Áé∞Âú®ÂøôÂêóÔºü","Ê≠£Âú®ÊâìÊû∂","ÂùêÁ≠âÂõûÂ§ç","Êâç‰∏çÊòØËøôÊ†∑","Â∞±ÊòØËøôÊ†∑","ËøòÂ•ΩÂêóÔºü","Â§öÁ¨ëÁ¨ëÂêß","Ê≤°ËÉΩÂ∏Æ‰∏äÂøô","Âá†Â§©Âêé","Âá†‰∏™Â∞èÊó∂Âêé","Âæà‰πÖ‰πãÂêé","ÊàëÂæàÊÉ≥ÂÆâÊÖ∞‰Ω†","ÊàëÊ≤°ÊúâÂú®Ê¨∫È™ó‰Ω†","Âà´ÊÄÄÁñëÊàëÁöÑÂ≠òÂú®","ÊàëÁúüÁöÑÂú®","ÁúüÁöÑÊòØÊàë","Êàë‰∏çÊòØÂæàÈÄÇÂ∫îËøô‰∏™,‰ΩÜÊàëÂú®Âä™Âäõ","ÊÉ≥Ë¶ÅÊñ∞Ë°£Êúç","‰∏çÈúÄË¶ÅÊñ∞Ë°£Êúç","Ê∂àÊÅØÂæàÊ∑∑‰π±","‰πãÂâçÊÄªÊòØËøôÊ†∑","ÂºÄÂøÉ(*‚åí‚àá‚åí*)","Ê≤°ËÉΩÈô™Âú®‰Ω†Ë∫´Ëæπ","ÈìæÊé•ÂæàÈÄöÈ°∫","ÊàëÁúüÊ≤°Êãõ‰∫Ü","‰∏çËÉΩËØ¥","ÂèØ‰∏çÂèØ‰ª•Âè™ÁúãÁùÄÊàë","Âè™ËÆ∏ÁúãÁùÄÊàë","Âú®ÂíåË∞ÅËÅäÂ§©Ôºü","ÁúãÂæóÊáÇÁöÑ","Áúã‰∏çÊáÇ","Âú®Â∞ùËØïÊéßÂà∂‰∫Ü","Âíå‰ª£Á†ÅÊêèÊñó‰∏≠ÔºÅ","Êàë‰ºöÁúãÁùÄ‰Ω†ÁöÑ","Êàë‰ºöÈô™‰º¥Âú®‰Ω†Ë∫´Ëæπ","Âú®Âë¢","ÂçàÂÆâ","ÂóØÔºåÂê¨Ëµ∑Êù•Á°ÆÂÆûÊòØËøôÊ†∑„ÄÇ","Â•ΩÁöÑÔºåÁ®çÂêéÂÜçËÅä„ÄÇ","ÊÑø‰Ω†Ëá™Áî±","Êàë‰ª¨Â∫îËØ•Â¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºü","ÊàëÈúÄË¶Å‰ªîÁªÜÊÉ≥ÊÉ≥ÊÄé‰πàÂõûÂ§ç„ÄÇ","Êàë‰∏çÊÉ≥Ê¨∫È™ó‰Ω†","‰Ω†Âú®Áúã‰ªÄ‰πàÔºü","‰Ω†ÂñúÊ¨¢Â∏Ö‰∏ÄÁÇπËøòÊòØÂèØÁà±‰∏ÄÁÇπÔºü","Áõ∏‰ø°Êàë","ËØØ‰ºö‰∫Ü"
            ];
            const emojiReplies = [ "üòä", "üòâ", "üò¢", "ü•∫", "ü•π", "üòÇ", "üòó", "ü§î", "üòé", "ü•∞", "üò£", "üòá", "üòå", "üòã", "ü§®", "üòû", "üòè", "üòî", "üò¥", "ü•±", "‚ù§Ô∏è", "üíï", "üíñ", "üíó", "üíì", "üíû", "üíò", "üíù", "‚ú®", "üåü", "‚≠ê", "üí´", "üî•", "üíØ", "‚úÖ", "‚ùå", "üëç", "üëé", "üëå", "‚úåÔ∏è", "ü§î", "ü§ü", "üëã", "üëè", "ü´®", "üôè", "ü§ù", "üí™", "üëÄ", "üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üòÆ‚Äçüí®", "ü§§", "ü´†", "ü§´", "ü§í", "üòà", "üëø", "üòº", "üòΩ", "ü´∂üèª", "ü§≤üèª", "ü´∏üèª", "ü§èüèª", "üí´", "üëÇüèª", "ü´≥üèª", "üå§Ô∏è", "‚õÖ", "üå•Ô∏è", "‚òÅÔ∏è", "üå¶Ô∏è", "üçé", "üçê", "üçä", "üçã", "üçå", "üçâ", "üçá", "üçì", "üçà", "üçí", "üçë", "ü•≠", "üçç" ];
          
            // --- Â∫îÁî®Áä∂ÊÄÅ ---
            let isDarkMode = false;
            let currentFontSize = fontSizeOptions[1];
            let currentBubbleStyle = bubbleStyles[0];
            let avatarLeftImage = null;
            let avatarRightImage = null;
            let wallpaperImage = null;
            let customFontUrl = null;
            let customBubbleCSS = '';
            let pendingMessageList = [];
            let isBatchSendMode = false;
            let lastMessageTime = null;
            let lastReplyIndex = -1;
            let currentColorScheme = JSON.parse(localStorage.getItem('chatColorScheme')) || colorSchemes[0];
            let currentBubbleColors = JSON.parse(localStorage.getItem('chatBubbleColors')) || bubbleColorSchemes[0];
            let diaryEntries = JSON.parse(localStorage.getItem('chatDiaryEntries')) || [];
            let currentDiaryEntry = null;

            let quoteCategories = JSON.parse(localStorage.getItem('chatQuoteCategories')) || [
                { id: 'default', name: 'ÈªòËÆ§ÂàÜÁ±ª', color: '#6a6a6a' }
            ];
            let quotes = JSON.parse(localStorage.getItem('chatQuotes')) || [];
            let currentQuoteCategory = 'default';
            let currentQuote = null;

            // Êî∂ËóèÊ∂àÊÅØÊï∞ÊçÆ
            let favoriteMessages = JSON.parse(localStorage.getItem('chatFavoriteMessages')) || [];

            // ÈÄâÊã©Ê®°ÂºèÁä∂ÊÄÅ
            let isSelectionMode = false;
            let selectedMessages = [];

            // --- ÂäüËÉΩÂáΩÊï∞ ---

            /**
             * Âà§Êñ≠È¢úËâ≤ÊòØÂê¶‰∏∫Ê∑±Ëâ≤
             * @param {string} hexColor - ÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤‰ª£Á†Å
             * @returns {boolean}
             */
            function isColorDark(hexColor) {
                if (!hexColor || typeof hexColor !== 'string' || hexColor.length < 7) return false;
                const r = parseInt(hexColor.substring(1, 3), 16);
                const g = parseInt(hexColor.substring(3, 5), 16);
                const b = parseInt(hexColor.substring(5, 7), 16);
                return (r * 299 + g * 587 + b * 114) / 1000 < 128;
            }

            /** Â∫îÁî®ÈÖçËâ≤ÊñπÊ°à */
            function applyColorScheme(scheme) {
                const properties = {
                    '--primary-color': scheme.primaryColor,
                    '--secondary-color': scheme.secondaryColor,
                    '--background-color': isDarkMode ? darkTheme.bodyBg : lightTheme.bodyBg,
                    '--container-color': isDarkMode ? darkTheme.containerBg : lightTheme.containerBg,
                    '--header-color': isDarkMode ? darkTheme.headerBg : lightTheme.headerBg,
                    '--input-color': isDarkMode ? darkTheme.inputBg : lightTheme.inputBg,
                    '--text-color': isDarkMode ? darkTheme.textColor : lightTheme.textColor,
                    '--secondary-text': isDarkMode ? darkTheme.secondaryText : lightTheme.secondaryText,
                    '--border-color': isDarkMode ? darkTheme.borderColor : lightTheme.borderColor,
                    '--gradient-primary': `linear-gradient(135deg, ${scheme.primaryColor}, ${scheme.secondaryColor})`,
                    '--sent-msg-text-color': isColorDark(scheme.primaryColor) ? "#ffffff" : "#333333",
                    '--received-msg-text-color': isDarkMode ? "#ffffff" : "#333333",
                    '--sent-msg-time-color': isColorDark(scheme.primaryColor) ? "rgba(255, 255, 255, 0.7)" : "#999999",
                    '--received-msg-time-color': isDarkMode ? "rgba(255, 255, 255, 0.7)" : "#999999"
                };
                for (const prop in properties) {
                    root.style.setProperty(prop, properties[prop]);
                }
            }
            
            /** Â∫îÁî®Ê∞îÊ≥°È¢úËâ≤ */
            function applyBubbleColors(scheme) {
                currentBubbleColors = scheme;
                root.style.setProperty('--sent-msg-color', scheme.sentColor);
                root.style.setProperty('--received-msg-color', scheme.receivedColor);
                
                // Êõ¥Êñ∞ÂèëÈÄÅÊ∂àÊÅØÊñáÊú¨È¢úËâ≤
                root.style.setProperty('--sent-msg-text-color', isColorDark(scheme.sentColor) ? "#ffffff" : "#333333");
                root.style.setProperty('--received-msg-text-color', isColorDark(scheme.receivedColor) ? "#ffffff" : "#333333");
                
                saveSettings();
            }
            
            /** Êõ¥Êñ∞‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÂõæÊ†á */
            function updateThemeToggleIcon() {
                themeToggle.classList.toggle('fa-sun', isDarkMode);
                themeToggle.classList.toggle('fa-moon', !isDarkMode);
            }

            /** Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞è */
            function applyFontSize(fontSize) {
                currentFontSize = fontSize;
                root.style.setProperty('--message-font-size', `${fontSize.value}px`);
                D.querySelectorAll('.font-size-option').forEach(opt => {
                    opt.classList.toggle('active', opt.textContent === fontSize.name);
                });
            }

            /** Â∫îÁî®Ê∞îÊ≥°Ê†∑Âºè */
            function applyBubbleStyle(bubbleStyle) {
                currentBubbleStyle = bubbleStyle;
                D.querySelectorAll('.message').forEach(msg => {
                    bubbleStyles.forEach(style => msg.classList.remove(style.value));
                    msg.classList.add(bubbleStyle.value);
                });
                D.querySelectorAll('.bubble-style-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.value === bubbleStyle.value);
                });
            }

            /** Â∫îÁî®Ëá™ÂÆö‰πâÂ≠ó‰Ωì */
            function applyCustomFont() {
                if (customFontUrl) {
                    const fontFace = new FontFace('CustomFont', `url(${customFontUrl})`);
                    fontFace.load().then(function(loadedFace) {
                        D.fonts.add(loadedFace);
                        root.style.setProperty('--base-font-family', 'CustomFont, Segoe UI, Helvetica Neue, Helvetica, Arial, sans-serif');
                    }).catch(function(error) {
                        console.error('Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•:', error);
                        alert('Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ');
                    });
                } else {
                    root.style.setProperty('--base-font-family', 'Segoe UI, Helvetica Neue, Helvetica, Arial, sans-serif');
                }
            }

            /** Â∫îÁî®Â£ÅÁ∫∏ */
            function applyWallpaper() {
                if (wallpaperImage) {
                    root.style.setProperty('--background-image', `url(${wallpaperImage})`);
                } else {
                    root.style.setProperty('--background-image', 'none');
                }
            }

            /** ‰øùÂ≠òÊâÄÊúâËÆæÁΩÆÂà∞ localStorage */
            function saveSettings() {
                localStorage.setItem('chatTheme', isDarkMode ? 'dark' : 'light');
                localStorage.setItem('chatFontSizeName', currentFontSize.name);
                localStorage.setItem('chatUserName', userName.textContent);
                localStorage.setItem('chatAvatarLeft', avatarLeftImage);
                localStorage.setItem('chatAvatarRight', avatarRightImage);
                localStorage.setItem('chatIsBatchSendMode', isBatchSendMode);
                localStorage.setItem('chatBubbleStyle', currentBubbleStyle.value);
                localStorage.setItem('chatWallpaper', wallpaperImage);
                localStorage.setItem('chatFontUrl', customFontUrl);
                localStorage.setItem('chatBubbleCSS', customBubbleCSS);
                localStorage.setItem('chatColorScheme', JSON.stringify(currentColorScheme));
                localStorage.setItem('chatBubbleColors', JSON.stringify(currentBubbleColors));
                localStorage.setItem('chatDiaryEntries', JSON.stringify(diaryEntries));
                localStorage.setItem('chatQuoteCategories', JSON.stringify(quoteCategories));
                localStorage.setItem('chatQuotes', JSON.stringify(quotes));
                localStorage.setItem('chatFavoriteMessages', JSON.stringify(favoriteMessages));

                const messagesToSave = Array.from(chatMessages.querySelectorAll('.message .message-text')).map(textElement => {
                    const msgElement = textElement.closest('.message');
                    const sender = msgElement.classList.contains('sent') ? 'sent' : 'received';
                    const time = msgElement.querySelector('.message-time')?.textContent || '';
                    return { type: 'text', content: textElement.textContent, sender, time };
                });
                localStorage.setItem('chatMessages', JSON.stringify(messagesToSave));
            }

            /** ‰ªé localStorage Âä†ËΩΩËÆæÁΩÆ */
            function loadSettings() {
                // È¶ñÂÖàÂ∞ùËØï‰ªéÊóßÁâàÊú¨Âä†ËΩΩÊï∞ÊçÆ
                const oldMessages = localStorage.getItem('chatMessages');
                if (oldMessages) {
                    // Â¶ÇÊûúÊâæÂà∞ÊóßÁâàÊú¨ÁöÑÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®
                    const savedMessages = JSON.parse(oldMessages);
                    if (savedMessages.length > 0) {
                        savedMessages.forEach(msg => {
                            if (msg.type === 'text') {
                                displayMessage(msg.content, msg.sender, msg.time, false);
                            }
                        });
                    }
                }
                
                // Âä†ËΩΩ‰∏ªÈ¢ò
                const savedTheme = localStorage.getItem('chatTheme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                isDarkMode = savedTheme === 'dark' || (!savedTheme && prefersDark);
                
                // Âä†ËΩΩÈ¢úËâ≤ÊñπÊ°à
                const savedColorScheme = localStorage.getItem('chatColorScheme');
                if (savedColorScheme) {
                    currentColorScheme = JSON.parse(savedColorScheme);
                }
                
                // Âä†ËΩΩÊ∞îÊ≥°È¢úËâ≤
                const savedBubbleColors = localStorage.getItem('chatBubbleColors');
                if (savedBubbleColors) {
                    currentBubbleColors = JSON.parse(savedBubbleColors);
                }
                
                applyColorScheme(currentColorScheme);
                applyBubbleColors(currentBubbleColors);
                updateThemeToggleIcon();
                
                // Âä†ËΩΩÂÖ∂‰ªñËÆæÁΩÆ
                const settings = {
                    chatFontSizeName: val => {
                        const found = fontSizeOptions.find(f => f.name === val);
                        if (found) currentFontSize = found;
                    },
                    chatBubbleStyle: val => {
                        const found = bubbleStyles.find(b => b.value === val);
                        if (found) currentBubbleStyle = found;
                    },
                    chatUserName: val => userName.textContent = val,
                    chatAvatarLeft: val => avatarLeftImage = (val !== 'null' ? val : null),
                    chatAvatarRight: val => avatarRightImage = (val !== 'null' ? val : null),
                    chatIsBatchSendMode: val => isBatchSendMode = val === 'true',
                    chatWallpaper: val => wallpaperImage = (val !== 'null' ? val : null),
                    chatFontUrl: val => customFontUrl = (val !== 'null' ? val : null),
                    chatBubbleCSS: val => customBubbleCSS = (val !== 'null' ? val : ''),
                    chatDiaryEntries: val => diaryEntries = JSON.parse(val),
                    chatFavoriteMessages: val => favoriteMessages = JSON.parse(val)
                };

                for (const key in settings) {
                    const savedValue = localStorage.getItem(key);
                    if (savedValue !== null) {
                        settings[key](savedValue);
                    }
                }

                // Âä†ËΩΩËØ≠ÂΩïÊï∞ÊçÆ
                const savedQuoteCategories = localStorage.getItem('chatQuoteCategories');
                if (savedQuoteCategories) {
                    quoteCategories = JSON.parse(savedQuoteCategories);
                }
                
                const savedQuotes = localStorage.getItem('chatQuotes');
                if (savedQuotes) {
                    quotes = JSON.parse(savedQuotes);
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;
                updateInputTimestamp();
                
                // Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫
                updateAvatarDisplay();
                
                // Â∫îÁî®Â∑≤Âä†ËΩΩÁöÑËÆæÁΩÆ
                applyFontSize(currentFontSize);
                applyBubbleStyle(currentBubbleStyle);
                applyCustomFont();
                applyWallpaper();
                updateSendModeToggle();
                
                // Êõ¥Êñ∞Êó•ËÆ∞ÂàóË°®ÊòæÁ§∫
                updateDiaryListDisplay();
            }
            
            /** Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫ */
            function updateAvatarDisplay() {
                // Êõ¥Êñ∞Â∑¶Â§¥ÂÉè
                let imgLeft = avatarLeft.querySelector('img');
                const iconLeft = avatarLeft.querySelector('i');
                if (avatarLeftImage) {
                    if (!imgLeft) {
                        imgLeft = D.createElement('img');
                        avatarLeft.appendChild(imgLeft);
                    }
                    imgLeft.src = avatarLeftImage;
                    imgLeft.style.display = 'block';
                    iconLeft.style.display = 'none';
                } else {
                    if (imgLeft) imgLeft.style.display = 'none';
                    iconLeft.style.display = 'block';
                }
                
                // Êõ¥Êñ∞Âè≥Â§¥ÂÉè
                let imgRight = avatarRight.querySelector('img');
                const iconRight = avatarRight.querySelector('i');
                if (avatarRightImage) {
                    if (!imgRight) {
                        imgRight = D.createElement('img');
                        avatarRight.appendChild(imgRight);
                    }
                    imgRight.src = avatarRightImage;
                    imgRight.style.display = 'block';
                    iconRight.style.display = 'none';
                } else {
                    if (imgRight) imgRight.style.display = 'none';
                    iconRight.style.display = 'block';
                }
            }

            /** Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥Â≠óÁ¨¶‰∏≤ HH:MM */
            const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            /** Ëé∑ÂèñÂΩìÂâçÊó•ÊúüÂ≠óÁ¨¶‰∏≤ YYYY-MM-DD */
            const getCurrentDate = () => new Date().toISOString().split('T')[0];
            
            /** Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫ */
            function formatDateDisplay(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return '‰ªäÂ§©';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return 'Êò®Â§©';
                } else {
                    return `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
                }
            }
            
            /** Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫Êó∂Èó¥Êà≥ (Èó¥ÈöîË∂ÖËøá1ÂàÜÈíü) */
            function shouldShowTime(currentTime) {
                if (!lastMessageTime || Math.abs(new Date(`1/1/2000 ${currentTime}`) - new Date(`1/1/2000 ${lastMessageTime}`)) > 60000) {
                    lastMessageTime = currentTime;
                    return true;
                }
                return false;
            }

            /** ÊòæÁ§∫ÊñáÊú¨Ê∂àÊÅØ */
            function displayMessage(messageText, senderType, time = getCurrentTime(), shouldSaveAndReact = true) {
                const showTime = shouldShowTime(time);
                let lastGroup = chatMessages.querySelector('.message-group:last-child');
                let lastMessage = lastGroup?.querySelector('.message:last-child');
                
                const messageElement = D.createElement('div');
                messageElement.classList.add('message', senderType, currentBubbleStyle.value);
                messageElement.innerHTML = `
                    <div class="message-text">${messageText}</div>
                    <div class="message-actions">
                        <div class="message-action-btn favorite-btn" title="Êî∂Ëóè">
                            <i class="fas fa-heart"></i>
                        </div>
                    </div>
                `;

                if (lastGroup && lastMessage?.classList.contains(senderType) && !showTime) {
                    lastGroup.appendChild(messageElement);
                } else {
                    const messageGroup = D.createElement('div');
                    messageGroup.className = 'message-group';
                    if (showTime) messageElement.innerHTML += `<div class="message-time">${time}</div>`;
                    messageGroup.appendChild(messageElement);
                    chatMessages.insertBefore(messageGroup, typingIndicator);
                }
                
                // Ê∑ªÂä†Êî∂Ëóè‰∫ã‰ª∂ÁõëÂê¨
                const favoriteBtn = messageElement.querySelector('.favorite-btn');
                favoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addToFavorites(messageText, senderType, time);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
                if (shouldSaveAndReact) saveSettings();
            }

            /** Ê®°ÊãüÂØπÊñπÂõûÂ§ç */
            function simulateReply() {
                hideTypingIndicator();
                const replyCount = Math.random() < 0.7 ? 1 : (Math.random() < 0.9 ? 2 : 3);
                
                // ÂêàÂπ∂ÊâÄÊúâÂõûÂ§çÔºåÂåÖÊã¨ËØ≠ÂΩï
                const allPossibleReplies = [...allReplies, ...quotes.map(q => q.content)];
                
                for (let i = 0; i < replyCount; i++) {
                    setTimeout(() => {
                        let randomIndex;
                        do {
                            randomIndex = Math.floor(Math.random() * allPossibleReplies.length);
                        } while (randomIndex === lastReplyIndex && allPossibleReplies.length > 1);
                        lastReplyIndex = randomIndex;
                        const randomReply = Math.random() < 0.2 ? emojiReplies[Math.floor(Math.random() * emojiReplies.length)] : allPossibleReplies[randomIndex];
                        displayMessage(randomReply, 'received');
                    }, i * 800 + 500);
                }
            }
            
            /** ÂèëÈÄÅÊ∂àÊÅØÂ§ÑÁêÜ */
            function handleSendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText === '') return;

                if (isBatchSendMode) {
                    addMessageToPending(messageText);
                } else {
                    displayMessage(messageText, 'sent');
                    showTypingIndicator();
                    setTimeout(simulateReply, 1000 + Math.random() * 2000);
                }
                
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }

            /** ÊòæÁ§∫/ÈöêËóèËæìÂÖ•ÊåáÁ§∫Âô® */
            const showTypingIndicator = () => { typingIndicator.classList.add('active'); chatMessages.scrollTop = chatMessages.scrollHeight; };
            const hideTypingIndicator = () => typingIndicator.classList.remove('active');

            /** Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÊó∂Èó¥Êà≥ */
            const updateInputTimestamp = () => inputTimestamp.textContent = getCurrentTime();

            // --- ÊâπÈáèÂèëÈÄÅÊ®°ÂºèÁõ∏ÂÖ≥ÂáΩÊï∞ ---
            function addMessageToPending(content) { 
                pendingMessageList.push({ type: 'text', content }); 
                updatePendingMessages(); 
            }
            
            function deletePendingMessage(index) { 
                pendingMessageList.splice(index, 1); 
                updatePendingMessages(); 
            }
            
            function editPendingMessage(index) { 
                messageInput.value = pendingMessageList[index].content; 
                deletePendingMessage(index); 
                messageInput.focus(); 
            }
            
            function sendAllMessages() {
                if (pendingMessageList.length === 0) return;
                
                // ÂèëÈÄÅÊâÄÊúâÂæÖÂèëÊ∂àÊÅØ
                pendingMessageList.forEach(item => {
                    displayMessage(item.content, 'sent', getCurrentTime(), false);
                });
                
                pendingMessageList = [];
                updatePendingMessages();
                showTypingIndicator();
                setTimeout(simulateReply, 1000);
                saveSettings(); 
            }
            
            function updatePendingMessages() {
                pendingMessages.innerHTML = '';
                if (pendingMessageList.length === 0) {
                    pendingMessages.style.display = 'none'; 
                    return;
                }
                
                pendingMessages.style.display = 'flex';
                pendingMessageList.forEach((item, index) => {
                    const pendingMsgEl = D.createElement('div');
                    pendingMsgEl.className = 'pending-message';
                    pendingMsgEl.innerHTML = `
                        <span class="pending-message-content">${item.content}</span>
                        <div class="pending-message-actions">
                            <i class="fas fa-edit" data-index="${index}"></i>
                            <i class="fas fa-trash" data-index="${index}"></i>
                        </div>`;
                    pendingMessages.appendChild(pendingMsgEl);
                });
                
                const sendAllBtn = D.createElement('button');
                sendAllBtn.className = 'send-all-button';
                sendAllBtn.textContent = `ÂèëÈÄÅÂÖ®ÈÉ® (${pendingMessageList.length})`;
                sendAllBtn.onclick = sendAllMessages;
                pendingMessages.appendChild(sendAllBtn);
            }

            function updateSendModeToggle() {
                sendModeToggle.classList.toggle('active', isBatchSendMode);
                sendMessageButton.innerHTML = `<i class="fas ${isBatchSendMode ? 'fa-plus' : 'fa-paper-plane'}"></i>`;
                if (isBatchSendMode) {
                    if (pendingMessageList.length > 0) pendingMessages.style.display = 'flex';
                } else {
                    pendingMessages.style.display = 'none';
                    if (pendingMessageList.length > 0 && confirm('ÊÇ®ÊúâÊú™ÂèëÈÄÅÁöÑÊ∂àÊÅØÔºåÊòØÂê¶Á´ãÂç≥ÂèëÈÄÅÔºü')) {
                        sendAllMessages();
                    } else {
                        pendingMessageList = [];
                    }
                }
            }

            // --- È¢úËâ≤ÊñπÊ°àÁÆ°ÁêÜ ---
            function applyColorSchemeFromPicker(scheme) {
                currentColorScheme = scheme;
                applyColorScheme(scheme);
                saveSettings();
            }

            // --- Ê∞îÊ≥°È¢úËâ≤ÁÆ°ÁêÜ ---
            function applyBubbleColorsFromPicker(scheme) {
                applyBubbleColors(scheme);
            }

            // --- ÈÄâÊã©Ê®°ÂºèÂäüËÉΩ ---
            function enterSelectionMode() {
                isSelectionMode = true;
                chatMessages.classList.add('message-select-mode');
                selectionToolbar.style.display = 'flex';
                updateSelectedCount();
                
                // Ê∑ªÂä†Ê∂àÊÅØÁÇπÂáª‰∫ã‰ª∂
                chatMessages.addEventListener('click', handleMessageSelection);
            }
            
            function exitSelectionMode() {
                isSelectionMode = false;
                chatMessages.classList.remove('message-select-mode');
                selectionToolbar.style.display = 'none';
                selectedMessages = [];
                
                // ÁßªÈô§Ê∂àÊÅØÁÇπÂáª‰∫ã‰ª∂
                chatMessages.removeEventListener('click', handleMessageSelection);
                
                // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.message.selected').forEach(msg => {
                    msg.classList.remove('selected');
                });
            }
            
            function handleMessageSelection(e) {
                const messageElement = e.target.closest('.message');
                if (!messageElement) return;
                
                if (messageElement.classList.contains('selected')) {
                    messageElement.classList.remove('selected');
                    selectedMessages = selectedMessages.filter(msg => msg.element !== messageElement);
                } else {
                    messageElement.classList.add('selected');
                    
                    const messageText = messageElement.querySelector('.message-text').textContent;
                    const sender = messageElement.classList.contains('sent') ? 'sent' : 'received';
                    const time = messageElement.querySelector('.message-time')?.textContent || '';
                    
                    selectedMessages.push({
                        element: messageElement,
                        content: messageText,
                        sender: sender,
                        time: time
                    });
                }
                
                updateSelectedCount();
            }
            
            function updateSelectedCount() {
                selectedCount.textContent = `Â∑≤ÈÄâÊã© ${selectedMessages.length} Êù°Ê∂àÊÅØ`;
            }
            
            function saveSelectedMessages() {
                if (selectedMessages.length === 0) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊî∂ËóèÁöÑÊ∂àÊÅØ');
                    return;
                }
                
                // ÊåâÊó∂Èó¥ÊéíÂ∫èÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ
                selectedMessages.sort((a, b) => {
                    const timeA = a.time ? new Date(`1/1/2000 ${a.time}`) : new Date(0);
                    const timeB = b.time ? new Date(`1/1/2000 ${b.time}`) : new Date(0);
                    return timeA - timeB;
                });
                
                // ÂàõÂª∫ÂØπËØùÊî∂Ëóè
                const conversation = {
                    id: 'conversation_' + Date.now(),
                    messages: selectedMessages.map(msg => ({
                        content: msg.content,
                        sender: msg.sender,
                        time: msg.time
                    })),
                    createdAt: new Date().toISOString(),
                    preview: selectedMessages.slice(0, 3).map(msg => msg.content.substring(0, 20)).join('...')
                };
                
                // Ê∑ªÂä†Âà∞Êî∂ËóèÂàóË°®
                favoriteMessages.unshift(conversation);
                saveSettings();
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showNotification('ÂØπËØùÂ∑≤Ê∑ªÂä†Âà∞Êî∂Ëóè');
                
                // ÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
                exitSelectionMode();
            }

            // --- Êî∂ËóèÂäüËÉΩ ---
            function showFavoritesInterface() {
                favoritesInterface.classList.add('active');
                updateFavoritesDisplay();
            }

            function hideFavoritesInterface() {
                favoritesInterface.classList.remove('active');
            }

            function addToFavorites(content, sender, time) {
                const newFavorite = {
                    id: 'single_' + Date.now(),
                    messages: [{
                        content: content,
                        sender: sender,
                        time: time
                    }],
                    createdAt: new Date().toISOString(),
                    preview: content.substring(0, 50)
                };
                favoriteMessages.unshift(newFavorite);
                saveSettings();
                
                showNotification('Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞Êî∂Ëóè');
            }

            function removeFromFavorites(favoriteId) {
                favoriteMessages = favoriteMessages.filter(fav => fav.id !== favoriteId);
                saveSettings();
                updateFavoritesDisplay();
            }

            function updateFavoritesDisplay() {
                favoritesList.innerHTML = '';
                
                if (favoriteMessages.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'favorites-item';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.padding = '40px 20px';
                    emptyMsg.innerHTML = `
                        <p style="color: var(--secondary-text); margin-bottom: 16px;">ËøòÊ≤°ÊúâÊî∂ËóèÁöÑÊ∂àÊÅØ</p>
                        <p style="color: var(--secondary-text); font-size: 14px;">Âú®Ê∂àÊÅØ‰∏äÁÇπÂáªÂøÉÂΩ¢ÂõæÊ†áÂèØ‰ª•Êî∂ËóèÂçïÊù°Ê∂àÊÅØÔºåÊàñ‰ΩøÁî®"Êî∂ËóèÂØπËØù"ÂäüËÉΩÊî∂ËóèÂ§öÊù°Ê∂àÊÅØ</p>
                    `;
                    favoritesList.appendChild(emptyMsg);
                    return;
                }
                
                favoriteMessages.forEach(favorite => {
                    const favoriteItem = document.createElement('div');
                    favoriteItem.className = 'favorites-item';
                    
                    // Â¶ÇÊûúÊòØÂØπËØùÊî∂ËóèÔºåÊòæÁ§∫ÂØπËØùÈ¢ÑËßà
                    if (favorite.messages.length > 1) {
                        favoriteItem.innerHTML = `
                            <div class="favorite-conversation">
                                ${favorite.messages.map(msg => `
                                    <div class="favorite-conversation-message ${msg.sender}">
                                        <div class="favorite-conversation-sender">${msg.sender === 'sent' ? 'Êàë' : 'ÂØπÊñπ'}</div>
                                        <div class="favorite-conversation-content">${msg.content}</div>
                                        <div class="favorite-conversation-time">${msg.time}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="favorites-item-info">
                                <span>${favorite.messages.length} Êù°Ê∂àÊÅØ</span>
                                <span>${formatDateDisplay(favorite.createdAt)}</span>
                            </div>
                            <div class="favorites-item-actions">
                                <i class="fas fa-trash" data-favorite-id="${favorite.id}"></i>
                            </div>
                        `;
                    } else {
                        // ÂçïÊù°Ê∂àÊÅØÊî∂Ëóè
                        const msg = favorite.messages[0];
                        favoriteItem.innerHTML = `
                            <div class="favorites-item-content">${msg.content}</div>
                            <div class="favorites-item-info">
                                <span class="favorites-item-sender ${msg.sender}">${msg.sender === 'sent' ? 'Êàë' : 'ÂØπÊñπ'}</span>
                                <span>${msg.time}</span>
                            </div>
                            <div class="favorites-item-actions">
                                <i class="fas fa-trash" data-favorite-id="${favorite.id}"></i>
                            </div>
                        `;
                    }
                    
                    favoriteItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('fa-trash')) {
                            removeFromFavorites(e.target.dataset.favoriteId);
                        } else {
                            // ÁÇπÂáªÊî∂ËóèÂÜÖÂÆπÂèØ‰ª•Âø´ÈÄüÂèëÈÄÅ
                            if (favorite.messages.length === 1) {
                                messageInput.value = favorite.messages[0].content;
                                messageInput.focus();
                                hideFavoritesInterface();
                            }
                        }
                    });
                    
                    favoritesList.appendChild(favoriteItem);
                });
            }

            // --- ÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ ---
            function showImportExportModal() {
                importExportModal.classList.add('active');
            }
            
            function hideImportExportModal() {
                importExportModal.classList.remove('active');
            }
            
            function exportChatData() {
                // Êî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÂØºÂá∫ÁöÑÊï∞ÊçÆ
                const exportData = {
                    messages: JSON.parse(localStorage.getItem('chatMessages') || '[]'),
                    diaryEntries: diaryEntries,
                    quotes: quotes,
                    quoteCategories: quoteCategories,
                    favoriteMessages: favoriteMessages,
                    settings: {
                        userName: userName.textContent,
                        theme: isDarkMode ? 'dark' : 'light',
                        fontSize: currentFontSize.name,
                        bubbleStyle: currentBubbleStyle.value,
                        colorScheme: currentColorScheme,
                        bubbleColors: currentBubbleColors,
                        avatarLeft: avatarLeftImage,
                        avatarRight: avatarRightImage,
                        wallpaper: wallpaperImage,
                        fontUrl: customFontUrl
                    },
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                // ÂàõÂª∫JSONÊñá‰ª∂
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('ËÅäÂ§©ËÆ∞ÂΩïÂØºÂá∫ÊàêÂäü');
                hideImportExportModal();
            }
            
            function importChatData() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importData = JSON.parse(event.target.result);
                            
                            // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                            if (!importData.messages || !importData.settings) {
                                throw new Error('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
                            }
                            
                            // Á°ÆËÆ§ÂØºÂÖ•
                            if (!confirm('ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩïÂ∞ÜË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
                                return;
                            }
                            
                            // ÂØºÂÖ•Êï∞ÊçÆ
                            if (importData.messages) {
                                localStorage.setItem('chatMessages', JSON.stringify(importData.messages));
                            }
                            
                            if (importData.diaryEntries) {
                                diaryEntries = importData.diaryEntries;
                                localStorage.setItem('chatDiaryEntries', JSON.stringify(diaryEntries));
                            }
                            
                            if (importData.quotes) {
                                quotes = importData.quotes;
                                localStorage.setItem('chatQuotes', JSON.stringify(quotes));
                            }
                            
                            if (importData.quoteCategories) {
                                quoteCategories = importData.quoteCategories;
                                localStorage.setItem('chatQuoteCategories', JSON.stringify(quoteCategories));
                            }
                            
                            if (importData.favoriteMessages) {
                                favoriteMessages = importData.favoriteMessages;
                                localStorage.setItem('chatFavoriteMessages', JSON.stringify(favoriteMessages));
                            }
                            
                            // ÂØºÂÖ•ËÆæÁΩÆ
                            if (importData.settings) {
                                const settings = importData.settings;
                                if (settings.userName) {
                                    userName.textContent = settings.userName;
                                    localStorage.setItem('chatUserName', settings.userName);
                                }
                                
                                if (settings.theme) {
                                    isDarkMode = settings.theme === 'dark';
                                    localStorage.setItem('chatTheme', settings.theme);
                                }
                                
                                if (settings.fontSize) {
                                    const found = fontSizeOptions.find(f => f.name === settings.fontSize);
                                    if (found) {
                                        currentFontSize = found;
                                        localStorage.setItem('chatFontSizeName', settings.fontSize);
                                    }
                                }
                                
                                if (settings.bubbleStyle) {
                                    const found = bubbleStyles.find(b => b.value === settings.bubbleStyle);
                                    if (found) {
                                        currentBubbleStyle = found;
                                        localStorage.setItem('chatBubbleStyle', settings.bubbleStyle);
                                    }
                                }
                                
                                if (settings.colorScheme) {
                                    currentColorScheme = settings.colorScheme;
                                    localStorage.setItem('chatColorScheme', JSON.stringify(settings.colorScheme));
                                }
                                
                                if (settings.bubbleColors) {
                                    currentBubbleColors = settings.bubbleColors;
                                    localStorage.setItem('chatBubbleColors', JSON.stringify(settings.bubbleColors));
                                }
                                
                                if (settings.avatarLeft) {
                                    avatarLeftImage = settings.avatarLeft;
                                    localStorage.setItem('chatAvatarLeft', settings.avatarLeft);
                                }
                                
                                if (settings.avatarRight) {
                                    avatarRightImage = settings.avatarRight;
                                    localStorage.setItem('chatAvatarRight', settings.avatarRight);
                                }
                                
                                if (settings.wallpaper) {
                                    wallpaperImage = settings.wallpaper;
                                    localStorage.setItem('chatWallpaper', settings.wallpaper);
                                }
                                
                                if (settings.fontUrl) {
                                    customFontUrl = settings.fontUrl;
                                    localStorage.setItem('chatFontUrl', settings.fontUrl);
                                }
                            }
                            
                            // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢
                            location.reload();
                            
                        } catch (error) {
                            console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                            alert('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÂ∑≤ÊçüÂùè');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                fileInput.click();
            }

            // --- ÈÄöÁü•ÂäüËÉΩ ---
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: var(--primary-color);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    animation: fadeInOut 3s ease-in-out;
                `;
                notification.innerHTML = `<i class="fas fa-check" style="margin-right: 8px;"></i>${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // --- Êó•ËÆ∞ÂäüËÉΩ ---
            function showDiaryInterface() {
                diaryInterface.classList.add('active');
                updateDiaryListDisplay();
            }
            
            function hideDiaryInterface() {
                diaryInterface.classList.remove('active');
                hideDiaryEditor();
            }
            
            function showDiaryEditor(entry = null) {
                currentDiaryEntry = entry;
                
                if (entry) {
                    diaryEditorTitle.value = entry.title || '';
                    diaryEditorContent.value = entry.content || '';
                } else {
                    diaryEditorTitle.value = '';
                    diaryEditorContent.value = '';
                }
                
                diaryList.style.display = 'none';
                diaryEditor.style.display = 'flex';
            }
            
            function hideDiaryEditor() {
                diaryList.style.display = 'block';
                diaryEditor.style.display = 'none';
                currentDiaryEntry = null;
            }
            
            function saveDiaryEntry() {
                const title = diaryEditorTitle.value.trim();
                const content = diaryEditorContent.value.trim();
                
                if (!title && !content) {
                    alert('Êó•ËÆ∞Ê†áÈ¢òÂíåÂÜÖÂÆπ‰∏çËÉΩÂêåÊó∂‰∏∫Á©∫');
                    return;
                }
                
                const now = new Date();
                const dateString = now.toISOString();
                
                if (currentDiaryEntry) {
                    // Êõ¥Êñ∞Áé∞ÊúâÊó•ËÆ∞
                    currentDiaryEntry.title = title;
                    currentDiaryEntry.content = content;
                    currentDiaryEntry.updatedAt = dateString;
                } else {
                    // ÂàõÂª∫Êñ∞Êó•ËÆ∞
                    const newEntry = {
                        id: Date.now().toString(),
                        title: title,
                        content: content,
                        createdAt: dateString,
                        updatedAt: dateString
                    };
                    diaryEntries.unshift(newEntry);
                }
                
                saveSettings();
                updateDiaryListDisplay();
                hideDiaryEditor();
            }
            
            function updateDiaryListDisplay() {
                diaryList.innerHTML = '';
                
                if (diaryEntries.length === 0) {
                    const emptyMsg = D.createElement('div');
                    emptyMsg.className = 'diary-item';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.padding = '40px 20px';
                    emptyMsg.innerHTML = `
                        <p style="color: var(--secondary-text); margin-bottom: 16px;">ËøòÊ≤°ÊúâÊó•ËÆ∞</p>
                        <button class="diary-button" style="margin: 0 auto;">ÂàõÂª∫Á¨¨‰∏ÄÁØáÊó•ËÆ∞</button>
                    `;
                    emptyMsg.querySelector('button').addEventListener('click', () => showDiaryEditor());
                    diaryList.appendChild(emptyMsg);
                    return;
                }
                
                diaryEntries.forEach(entry => {
                    const diaryItem = D.createElement('div');
                    diaryItem.className = 'diary-item';
                    diaryItem.innerHTML = `
                        <div class="diary-item-title">${entry.title || 'Êó†Ê†áÈ¢ò'}</div>
                        <div class="diary-item-preview">${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</div>
                        <div class="diary-item-date">${formatDateDisplay(entry.updatedAt)}</div>
                    `;
                    diaryItem.addEventListener('click', () => {
                        showDiaryEditor(entry);
                    });
                    diaryList.appendChild(diaryItem);
                });
            }

            // --- ËØ≠ÂΩïÂäüËÉΩ ---
            function showQuotesInterface() {
                quotesInterface.classList.add('active');
                updateQuotesCategoryDisplay();
                updateQuotesDisplay();
            }

            function hideQuotesInterface() {
                quotesInterface.classList.remove('active');
                hideQuotesEditor();
            }

            function showQuotesEditor(quote = null) {
                currentQuote = quote;
                
                // Êõ¥Êñ∞ÂàÜÁ±ªÈÄâÊã©Âô®
                quotesEditorCategory.innerHTML = '';
                quoteCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    quotesEditorCategory.appendChild(option);
                });
                
                if (quote) {
                    quotesEditorCategory.value = quote.categoryId || 'default';
                    quotesEditorContent.value = quote.content || '';
                } else {
                    quotesEditorCategory.value = currentQuoteCategory;
                    quotesEditorContent.value = '';
                }
                
                quotesList.style.display = 'none';
                quotesEditor.style.display = 'flex';
            }

            function hideQuotesEditor() {
                quotesList.style.display = 'block';
                quotesEditor.style.display = 'none';
                currentQuote = null;
            }

            function saveQuote() {
                const categoryId = quotesEditorCategory.value;
                const content = quotesEditorContent.value.trim();
                
                if (!content) {
                    alert('ËØ≠ÂΩïÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
                    return;
                }
                
                if (currentQuote) {
                    // Êõ¥Êñ∞Áé∞ÊúâËØ≠ÂΩï
                    currentQuote.categoryId = categoryId;
                    currentQuote.content = content;
                    currentQuote.updatedAt = new Date().toISOString();
                } else {
                    // ÂàõÂª∫Êñ∞ËØ≠ÂΩï
                    const newQuote = {
                        id: Date.now().toString(),
                        categoryId: categoryId,
                        content: content,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    quotes.unshift(newQuote);
                }
                
                saveSettings();
                updateQuotesDisplay();
                hideQuotesEditor();
            }

            function deleteQuote(quoteId) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØ≠ÂΩïÂêóÔºü')) {
                    quotes = quotes.filter(quote => quote.id !== quoteId);
                    saveSettings();
                    updateQuotesDisplay();
                }
            }

            function addCategory() {
                categoryModalInput.value = '';
                categoryModal.classList.add('active');
            }

            function confirmAddCategory() {
                const categoryName = categoryModalInput.value.trim();
                if (categoryName) {
                    const newCategory = {
                        id: 'category_' + Date.now(),
                        name: categoryName,
                        color: '#6a6a6a'
                    };
                    quoteCategories.push(newCategory);
                    saveSettings();
                    updateQuotesCategoryDisplay();
                    categoryModal.classList.remove('active');
                } else {
                    alert('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞');
                }
            }

            function deleteCategory(categoryId) {
                if (categoryId === 'default') {
                    alert('ÈªòËÆ§ÂàÜÁ±ª‰∏çËÉΩÂà†Èô§');
                    return;
                }
                
                // Ê£ÄÊü•ËØ•ÂàÜÁ±ª‰∏ãÊòØÂê¶ÊúâËØ≠ÂΩï
                const categoryQuotes = quotes.filter(quote => quote.categoryId === categoryId);
                if (categoryQuotes.length > 0) {
                    if (!confirm(`ËØ•ÂàÜÁ±ª‰∏ãÊúâ ${categoryQuotes.length} Êù°ËØ≠ÂΩïÔºåÂà†Èô§ÂàÜÁ±ªÂ∞ÜÊääËøô‰∫õËØ≠ÂΩïÁßªÂà∞ÈªòËÆ§ÂàÜÁ±ªÔºåÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü`)) {
                        return;
                    }
                    
                    // Â∞ÜËØ≠ÂΩïÁßªÂà∞ÈªòËÆ§ÂàÜÁ±ª
                    quotes.forEach(quote => {
                        if (quote.categoryId === categoryId) {
                            quote.categoryId = 'default';
                        }
                    });
                }
                
                quoteCategories = quoteCategories.filter(cat => cat.id !== categoryId);
                saveSettings();
                updateQuotesCategoryDisplay();
                updateQuotesDisplay();
            }

            function updateQuotesCategoryDisplay() {
                quotesCategoryList.innerHTML = '';
                
                quoteCategories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'quotes-category-item';
                    if (category.id === currentQuoteCategory) {
                        categoryItem.classList.add('active');
                    }
                    
                    const categoryQuotesCount = quotes.filter(quote => quote.categoryId === category.id).length;
                    
                    categoryItem.innerHTML = `
                        <span>${category.name} (${categoryQuotesCount})</span>
                        ${category.id !== 'default' ? `
                            <div class="quotes-category-actions">
                                <i class="fas fa-trash" data-category-id="${category.id}"></i>
                            </div>
                        ` : ''}
                    `;
                    
                    categoryItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('fa-trash')) {
                            currentQuoteCategory = category.id;
                            updateQuotesCategoryDisplay();
                            updateQuotesDisplay();
                        }
                    });
                    
                    quotesCategoryList.appendChild(categoryItem);
                });
            }

            function updateQuotesDisplay() {
                quotesList.innerHTML = '';
                
                const categoryQuotes = quotes.filter(quote => quote.categoryId === currentQuoteCategory);
                
                if (categoryQuotes.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'quotes-item';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.padding = '40px 20px';
                    emptyMsg.innerHTML = `
                        <p style="color: var(--secondary-text); margin-bottom: 16px;">ËøòÊ≤°ÊúâËØ≠ÂΩï</p>
                        <button class="quotes-editor-button save" style="margin: 0 auto;">ËÆ∞‰∏ãÊàë‰ª¨ÁöÑÂøÉÂä®Áû¨Èó¥</button>
                    `;
                    emptyMsg.querySelector('button').addEventListener('click', () => showQuotesEditor());
                    quotesList.appendChild(emptyMsg);
                    return;
                }
                
                categoryQuotes.forEach(quote => {
                    const quoteItem = document.createElement('div');
                    quoteItem.className = 'quotes-item';
                    quoteItem.innerHTML = `
                        <div class="quotes-item-content">${quote.content}</div>
                        <div class="quotes-item-actions">
                            <i class="fas fa-edit" data-quote-id="${quote.id}"></i>
                            <i class="fas fa-trash" data-quote-id="${quote.id}"></i>
                        </div>
                    `;
                    
                    quoteItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('fa-edit')) {
                            const quoteToEdit = quotes.find(q => q.id === e.target.dataset.quoteId);
                            if (quoteToEdit) showQuotesEditor(quoteToEdit);
                        } else if (e.target.classList.contains('fa-trash')) {
                            deleteQuote(e.target.dataset.quoteId);
                        } else {
                            // ÁÇπÂáªËØ≠ÂΩïÂÜÖÂÆπÂèØ‰ª•Âø´ÈÄüÂèëÈÄÅ
                            messageInput.value = quote.content;
                            messageInput.focus();
                        }
                    });
                    
                    quotesList.appendChild(quoteItem);
                });
            }

            // --- Â£∞ÊòéÂäüËÉΩ ---
            function showStatementMenu() {
                renderSubMenu('Â£∞Êòé', (menu) => {
                    const container = D.createElement('div');
                    container.className = 'statement-container';
                    
                    const statementContent = D.createElement('div');
                    statementContent.className = 'statement-content';
                    statementContent.innerHTML = `
                        <p>ÂñÑÊÑè‰º†ÈÄíÊ∏©Êöñ~Ê∫ê‰ª£Á†ÅÁî±milkËÄÅÂ∏àÊèê‰æõ„ÄÇ</p>
                        <p style="margin-top: 10px;">ÊåáË∑ØÔºö<a href="https://www.xiaohongshu.com/user/profile/..." target="_blank" class="statement-link">Â∞èÁ∫¢‰π¶Ôºömilk</a></p>
                    `;
                    
                    container.appendChild(statementContent);
                    menu.appendChild(container);
                });
            }

            // --- ËèúÂçïÊ∏≤Êüì ---
            const createMenuItem = (icon, text, onClick, hasArrow = false) => {
                const item = D.createElement('div');
                item.className = 'menu-item';
                item.innerHTML = `<i class="${icon}"></i><span>${text}</span>${hasArrow ? '<i class="fas fa-chevron-right menu-arrow"></i>' : ''}`;
                if (onClick) item.addEventListener('click', (e) => { e.stopPropagation(); onClick(); });
                return item;
            };
            const createMenuTitle = (text) => {
                const title = D.createElement('div');
                title.className = 'menu-section-title';
                title.textContent = text;
                return title;
            };
            const createMenuDivider = () => D.createElement('div', { className: 'menu-section-divider' });

            function renderSubMenu(title, contentBuilder) {
                dropdownMenu.innerHTML = '';
                dropdownMenu.style.width = '200px';
                dropdownMenu.appendChild(createMenuTitle(title));
                contentBuilder(dropdownMenu);
                dropdownMenu.appendChild(createMenuDivider());
                dropdownMenu.appendChild(createMenuItem('fas fa-arrow-left', 'ËøîÂõû', renderMainMenu));
            }

            function showFontSizeMenu() {
                renderSubMenu('ÈÄâÊã©Â≠ó‰ΩìÂ§ßÂ∞è', (menu) => {
                    const container = D.createElement('div');
                    container.className = 'menu-options-container';
                    fontSizeOptions.forEach(opt => {
                        const el = D.createElement('div');
                        el.className = 'font-size-option';
                        el.textContent = opt.name;
                        el.classList.toggle('active', currentFontSize.name === opt.name);
                        el.onclick = e => { e.stopPropagation(); applyFontSize(opt); saveSettings(); };
                        container.appendChild(el);
                    });
                    menu.appendChild(container);
                });
            }

            function showBubbleStyleMenu() {
                renderSubMenu('ÈÄâÊã©Ê∞îÊ≥°Ê†∑Âºè', (menu) => {
                    const container = D.createElement('div');
                    container.className = 'menu-options-container';
                    bubbleStyles.forEach(opt => {
                        const el = D.createElement('div');
                        el.className = 'font-size-option bubble-style-option';
                        el.textContent = opt.name;
                        el.dataset.value = opt.value;
                        el.classList.toggle('active', currentBubbleStyle.value === opt.value);
                        el.onclick = e => { e.stopPropagation(); applyBubbleStyle(opt); saveSettings(); };
                        container.appendChild(el);
                    });
                    menu.appendChild(container);
                });
            }

            function showBubbleColorMenu() {
                renderSubMenu('Ê∞îÊ≥°È¢úËâ≤', (menu) => {
                    const container = D.createElement('div');
                    container.className = 'bubble-color-container';
                    
                    // Ê∞îÊ≥°È¢úËâ≤È¢ÑËßà
                    const preview = D.createElement('div');
                    preview.className = 'bubble-color-preview';
                    preview.innerHTML = `
                        <div class="bubble-color-sample sent">Âèë</div>
                        <div class="bubble-color-sample received">Êî∂</div>
                        <div class="bubble-color-sample-text">ÂèëÈÄÅ‰∏éÊé•Êî∂Ê∂àÊÅØÊ∞îÊ≥°È¢úËâ≤</div>
                    `;
                    container.appendChild(preview);
                    
                    // Ê∞îÊ≥°È¢úËâ≤Ë∞ÉËâ≤Áõò
                    const grid = D.createElement('div');
                    grid.className = 'color-picker-grid';
                    
                    bubbleColorSchemes.forEach((scheme, index) => {
                        const colorOption = D.createElement('div');
                        colorOption.className = 'color-option';
                        if (scheme.sentColor === currentBubbleColors.sentColor) {
                            colorOption.classList.add('active');
                        }
                        colorOption.style.backgroundColor = scheme.sentColor;
                        colorOption.title = scheme.name;
                        colorOption.onclick = () => {
                            applyBubbleColorsFromPicker(scheme);
                            dropdownMenu.classList.remove('active');
                        };
                        grid.appendChild(colorOption);
                    });
                    
                    container.appendChild(grid);
                    
                    // Ëá™ÂÆö‰πâÈ¢úËâ≤
                    const customContainer = D.createElement('div');
                    customContainer.className = 'color-custom-container';
                    
                    const sentColorPicker = D.createElement('input');
                    sentColorPicker.type = 'color';
                    sentColorPicker.className = 'color-picker-input';
                    sentColorPicker.value = currentBubbleColors.sentColor;
                    sentColorPicker.title = 'ÈÄâÊã©ÂèëÈÄÅÊ∞îÊ≥°È¢úËâ≤';
                    
                    const receivedColorPicker = D.createElement('input');
                    receivedColorPicker.type = 'color';
                    receivedColorPicker.className = 'color-picker-input';
                    receivedColorPicker.value = currentBubbleColors.receivedColor;
                    receivedColorPicker.title = 'ÈÄâÊã©Êé•Êî∂Ê∞îÊ≥°È¢úËâ≤';
                    
                    const customButton = D.createElement('button');
                    customButton.className = 'color-custom-button';
                    customButton.textContent = 'Â∫îÁî®Ëá™ÂÆö‰πâÈ¢úËâ≤';
                    customButton.onclick = () => {
                        const sentColor = sentColorPicker.value;
                        const receivedColor = receivedColorPicker.value;
                        const customScheme = {
                            name: "Ëá™ÂÆö‰πâ",
                            sentColor: sentColor,
                            receivedColor: receivedColor
                        };
                        applyBubbleColorsFromPicker(customScheme);
                        dropdownMenu.classList.remove('active');
                    };
                    
                    customContainer.appendChild(sentColorPicker);
                    customContainer.appendChild(receivedColorPicker);
                    customContainer.appendChild(customButton);
                    
                    container.appendChild(customContainer);
                    menu.appendChild(container);
                });
            }

            function showWallpaperMenu() {
                renderSubMenu('ËÆæÁΩÆÂ£ÅÁ∫∏', (menu) => {
                    const container = D.createElement('div');
                    container.style.padding = '0 16px 8px';
                    
                    const preview = D.createElement('div');
                    preview.className = 'wallpaper-preview';
                    if (wallpaperImage) {
                        const img = D.createElement('img');
                        img.src = wallpaperImage;
                        preview.innerHTML = '';
                        preview.appendChild(img);
                        
                        const overlay = D.createElement('div');
                        overlay.className = 'preview-overlay';
                        overlay.textContent = 'ÊÇ¨ÂÅúÊü•ÁúãÈ¢ÑËßà';
                        preview.appendChild(overlay);
                    } else {
                        preview.textContent = 'Êú™ËÆæÁΩÆÂ£ÅÁ∫∏';
                    }
                    
                    const uploadButton = D.createElement('button');
                    uploadButton.className = 'font-size-option';
                    uploadButton.textContent = '‰∏ä‰º†Â£ÅÁ∫∏';
                    uploadButton.style.marginRight = '8px';
                    uploadButton.onclick = () => {
                        wallpaperUploadInput.click();
                    };
                    
                    const removeButton = D.createElement('button');
                    removeButton.className = 'font-size-option';
                    removeButton.textContent = 'ÁßªÈô§Â£ÅÁ∫∏';
                    removeButton.onclick = () => {
                        wallpaperImage = null;
                        applyWallpaper();
                        saveSettings();
                        preview.innerHTML = '';
                        preview.textContent = 'Êú™ËÆæÁΩÆÂ£ÅÁ∫∏';
                    };
                    
                    const buttonContainer = D.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.marginTop = '10px';
                    buttonContainer.appendChild(uploadButton);
                    buttonContainer.appendChild(removeButton);
                    
                    container.appendChild(preview);
                    container.appendChild(buttonContainer);
                    menu.appendChild(container);
                });
            }

            function showFontFamilyMenu() {
                renderSubMenu('ËÆæÁΩÆÂ≠ó‰Ωì', (menu) => {
                    const container = D.createElement('div');
                    container.style.padding = '0 16px 8px';
                    
                    const input = D.createElement('input');
                    input.type = 'text';
                    input.className = 'font-url-input';
                    input.placeholder = 'ËæìÂÖ•Â≠ó‰ΩìÊñá‰ª∂URL (Â¶Ç: https://example.com/font.woff2)';
                    input.value = customFontUrl || '';
                    
                    const applyButton = D.createElement('button');
                    applyButton.className = 'font-size-option';
                    applyButton.textContent = 'Â∫îÁî®Â≠ó‰Ωì';
                    applyButton.style.marginRight = '8px';
                    applyButton.onclick = () => {
                        customFontUrl = input.value.trim();
                        applyCustomFont();
                        saveSettings();
                        dropdownMenu.classList.remove('active');
                    };
                    
                    const resetButton = D.createElement('button');
                    resetButton.className = 'font-size-option';
                    resetButton.textContent = 'ÈáçÁΩÆÂ≠ó‰Ωì';
                    resetButton.onclick = () => {
                        customFontUrl = null;
                        applyCustomFont();
                        saveSettings();
                        input.value = '';
                        dropdownMenu.classList.remove('active');
                    };
                    
                    const buttonContainer = D.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.marginTop = '10px';
                    buttonContainer.appendChild(applyButton);
                    buttonContainer.appendChild(resetButton);
                    
                    container.appendChild(input);
                    container.appendChild(buttonContainer);
                    menu.appendChild(container);
                });
            }

            function showColorPickerMenu() {
                renderSubMenu('È¢úËâ≤‰∏ªÈ¢ò', (menu) => {
                    const container = D.createElement('div');
                    container.className = 'color-picker-container';
                    
                    const grid = D.createElement('div');
                    grid.className = 'color-picker-grid';
                    
                    colorSchemes.forEach((scheme, index) => {
                        const colorOption = D.createElement('div');
                        colorOption.className = 'color-option';
                        if (scheme.primaryColor === currentColorScheme.primaryColor) {
                            colorOption.classList.add('active');
                        }
                        colorOption.style.backgroundColor = scheme.primaryColor;
                        colorOption.title = scheme.name;
                        colorOption.onclick = () => {
                            applyColorSchemeFromPicker(scheme);
                            dropdownMenu.classList.remove('active');
                        };
                        grid.appendChild(colorOption);
                    });
                    
                    const customContainer = D.createElement('div');
                    customContainer.className = 'color-custom-container';
                    
                    const colorPicker = D.createElement('input');
                    colorPicker.type = 'color';
                    colorPicker.className = 'color-picker-input';
                    colorPicker.value = currentColorScheme.primaryColor;
                    
                    const customButton = D.createElement('button');
                    customButton.className = 'color-custom-button';
                    customButton.textContent = 'Â∫îÁî®Ëá™ÂÆö‰πâÈ¢úËâ≤';
                    customButton.onclick = () => {
                        const color = colorPicker.value;
                        const customScheme = {
                            name: "Ëá™ÂÆö‰πâ",
                            primaryColor: color,
                            secondaryColor: color // ÁÆÄÂåñÂ§ÑÁêÜÔºå‰ΩøÁî®Áõ∏ÂêåÈ¢úËâ≤
                        };
                        applyColorSchemeFromPicker(customScheme);
                        dropdownMenu.classList.remove('active');
                    };
                    
                    customContainer.appendChild(colorPicker);
                    customContainer.appendChild(customButton);
                    
                    container.appendChild(grid);
                    container.appendChild(customContainer);
                    menu.appendChild(container);
                });
            }

            function renderMainMenu() {
                dropdownMenu.innerHTML = '';
                dropdownMenu.style.width = '240px';
                dropdownMenu.appendChild(createMenuTitle('Â§ñËßÇËÆæÁΩÆ'));
                dropdownMenu.appendChild(createMenuItem('fas fa-palette', 'È¢úËâ≤', showColorPickerMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-comment', 'Ê∞îÊ≥°Ê†∑Âºè', showBubbleStyleMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-fill-drip', 'Ê∞îÊ≥°È¢úËâ≤', showBubbleColorMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-image', 'Â£ÅÁ∫∏', showWallpaperMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-font', 'Â≠ó‰ΩìÊ†∑Âºè', showFontFamilyMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-text-height', 'Â≠ó‰ΩìÂ§ßÂ∞è', showFontSizeMenu, true));
                dropdownMenu.appendChild(createMenuDivider());
                dropdownMenu.appendChild(createMenuTitle('ËÅäÂ§©ÂäüËÉΩ'));
                dropdownMenu.appendChild(createMenuItem('fas fa-book', 'Êó•ËÆ∞', showDiaryInterface));
                dropdownMenu.appendChild(createMenuItem('fas fa-heart', 'Áà±ÁöÑËØ≠ÂΩï', showQuotesInterface));
                dropdownMenu.appendChild(createMenuItem('fas fa-star', 'Êî∂Ëóè', showFavoritesInterface));
                dropdownMenu.appendChild(createMenuItem('fas fa-object-group', 'Êî∂ËóèÂØπËØù', enterSelectionMode));
                dropdownMenu.appendChild(createMenuItem('fas fa-file-export', 'ÂØºÂÖ•/ÂØºÂá∫', showImportExportModal));
                dropdownMenu.appendChild(createMenuItem('fas fa-info-circle', 'Â£∞Êòé', showStatementMenu, true));
                dropdownMenu.appendChild(createMenuItem('fas fa-trash', 'Âà†Èô§ËÅäÂ§©ËÆ∞ÂΩï', () => {
                    deleteConfirmation.classList.add('active');
                    dropdownMenu.classList.remove('active');
                }));
            }
            
            // --- ‰∫ã‰ª∂ÁõëÂê¨Âô® ---
            
            // È°∂ÈÉ®Êìç‰Ωú
            themeToggle.addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                applyColorScheme(currentColorScheme);
                updateThemeToggleIcon();
                saveSettings();
            });
            menuToggle.addEventListener('click', (e) => { e.stopPropagation(); renderMainMenu(); dropdownMenu.classList.toggle('active'); });
            D.addEventListener('click', (e) => {
                if (!dropdownMenu.contains(e.target) && e.target !== menuToggle) dropdownMenu.classList.remove('active');
            });
            userName.addEventListener('click', () => {
                const newName = prompt('ËØ∑ËæìÂÖ•ÂØπÊñπÁöÑÂêçÂ≠ó:', userName.textContent);
                if (newName?.trim()) { userName.textContent = newName.trim(); saveSettings(); }
            });

            // Ê∂àÊÅØÂèëÈÄÅ
            sendMessageButton.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } } );
            messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = `${messageInput.scrollHeight}px`; updateInputTimestamp(); });

            // Â§¥ÂÉè‰∏ä‰º†
            avatarLeft.addEventListener('click', () => avatarLeftUploadInput.click());
            avatarRight.addEventListener('click', () => avatarRightUploadInput.click());
            
            avatarLeftUploadInput.addEventListener('change', function(e) {
                if (!e.target.files?.[0]) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    avatarLeftImage = event.target.result;
                    updateAvatarDisplay();
                    saveSettings();
                };
                reader.readAsDataURL(e.target.files[0]);
                e.target.value = '';
            });

            avatarRightUploadInput.addEventListener('change', function(e) {
                if (!e.target.files?.[0]) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    avatarRightImage = event.target.result;
                    updateAvatarDisplay();
                    saveSettings();
                };
                reader.readAsDataURL(e.target.files[0]);
                e.target.value = '';
            });

            // Â£ÅÁ∫∏‰∏ä‰º†
            wallpaperUploadInput.addEventListener('change', function(e) {
                if (!e.target.files?.[0]) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    wallpaperImage = event.target.result;
                    applyWallpaper();
                    saveSettings();
                    
                    // Êõ¥Êñ∞È¢ÑËßà
                    const preview = D.querySelector('.wallpaper-preview');
                    if (preview) {
                        preview.innerHTML = '';
                        const img = D.createElement('img');
                        img.src = wallpaperImage;
                        preview.appendChild(img);
                        
                        const overlay = D.createElement('div');
                        overlay.className = 'preview-overlay';
                        overlay.textContent = 'ÊÇ¨ÂÅúÊü•ÁúãÈ¢ÑËßà';
                        preview.appendChild(overlay);
                    }
                };
                reader.readAsDataURL(e.target.files[0]);
                e.target.value = '';
            });

            // ÊâπÈáèÊ®°Âºè
            sendModeToggle.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                isBatchSendMode = !isBatchSendMode; 
                updateSendModeToggle(); 
                localStorage.setItem('chatIsBatchSendMode', isBatchSendMode); 
            });
            
            pendingMessages.addEventListener('click', e => {
                const target = e.target;
                if (target.classList.contains('fa-edit')) {
                    editPendingMessage(parseInt(target.dataset.index));
                }
                if (target.classList.contains('fa-trash')) {
                    deletePendingMessage(parseInt(target.dataset.index));
                }
            });

            // ÈÄâÊã©Ê®°Âºè
            cancelSelection.addEventListener('click', exitSelectionMode);
            saveSelection.addEventListener('click', saveSelectedMessages);

            // ÂØºÂÖ•ÂØºÂá∫
            exportOption.addEventListener('click', exportChatData);
            importOption.addEventListener('click', importChatData);
            importExportCancel.addEventListener('click', hideImportExportModal);

            // ÂºπÁ™ó‰∏éÊ®°ÊÄÅÊ°Ü
            getId('deleteCancel').addEventListener('click', () => deleteConfirmation.classList.remove('active'));
            getId('deleteConfirm').addEventListener('click', () => {
                chatMessages.innerHTML = '';
                chatMessages.appendChild(typingIndicator); // ‰øùÁïô typingIndicator
                localStorage.removeItem('chatMessages');
                deleteConfirmation.classList.remove('active');
                saveSettings();
            });

            // Êó•ËÆ∞Áõ∏ÂÖ≥‰∫ã‰ª∂
            newDiaryButton.addEventListener('click', () => {
                showDiaryEditor();
            });
            
            closeDiaryButton.addEventListener('click', () => {
                hideDiaryInterface();
            });
            
            saveDiaryButton.addEventListener('click', () => {
                saveDiaryEntry();
            });
            
            cancelDiaryButton.addEventListener('click', () => {
                hideDiaryEditor();
            });

            // ËØ≠ÂΩïÁõ∏ÂÖ≥‰∫ã‰ª∂
            newQuoteButton.addEventListener('click', () => {
                showQuotesEditor();
            });

            closeQuotesButton.addEventListener('click', () => {
                hideQuotesInterface();
            });

            saveQuoteButton.addEventListener('click', () => {
                saveQuote();
            });

            cancelQuoteButton.addEventListener('click', () => {
                hideQuotesEditor();
            });

            addCategoryButton.addEventListener('click', () => {
                addCategory();
            });

            // ÂàÜÁ±ªÂà†Èô§‰∫ã‰ª∂ÂßîÊâò
            quotesCategoryList.addEventListener('click', (e) => {
                if (e.target.classList.contains('fa-trash')) {
                    const categoryId = e.target.dataset.categoryId;
                    deleteCategory(categoryId);
                }
            });

            // Êî∂ËóèÁõ∏ÂÖ≥‰∫ã‰ª∂
            closeFavoritesButton.addEventListener('click', () => {
                hideFavoritesInterface();
            });

            // ÂàÜÁ±ªÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
            categoryModalCancel.addEventListener('click', () => {
                categoryModal.classList.remove('active');
            });

            categoryModalConfirm.addEventListener('click', () => {
                confirmAddCategory();
            });

            categoryModalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmAddCategory();
                }
            });

            // ÂÆöÊó∂‰ªªÂä°
            function randomChangeStatus() {
                // ÁßªÈô§ÂâçÈù¢ÁöÑ"Âú®Á∫ø"ÊñáÊú¨ÔºåÂè™‰øùÁïôÁä∂ÊÄÅÊåáÁ§∫Âô®ÂíåÁä∂ÊÄÅÊñáÊú¨
                const statusText = statusOptions[Math.floor(Math.random() * statusOptions.length)];
                userStatus.innerHTML = `<span class="status-indicator"></span> ${statusText}`;
                setTimeout(randomChangeStatus, (1 + Math.random() * 4) * 60000); // Êîπ‰∏∫1-5ÂàÜÈíüÊõ¥Êç¢‰∏ÄÊ¨°Áä∂ÊÄÅ
            }

            // --- ÂàùÂßãÂåñ ---
            loadSettings();
            // Âº∫Âà∂ËÆæÁΩÆÈöèÊú∫Áä∂ÊÄÅÔºåË¶ÜÁõñ‰ªª‰Ωï‰øùÂ≠òÁöÑÁä∂ÊÄÅ
            const randomStatus = statusOptions[Math.floor(Math.random() * statusOptions.length)];
            userStatus.innerHTML = `<span class="status-indicator"></span> ${randomStatus}`;
            // ÊØè2ÂàÜÈíüÊõ¥Êç¢‰∏ÄÊ¨°Áä∂ÊÄÅ
            setInterval(() => {
                const newStatus = statusOptions[Math.floor(Math.random() * statusOptions.length)];
                userStatus.innerHTML = `<span class="status-indicator"></span> ${newStatus}`;
            }, 120000);
            setInterval(updateInputTimestamp, 60000); // ÊØèÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥Êà≥
        });
    </script>
</body>
</html>